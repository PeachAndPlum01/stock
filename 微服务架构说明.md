# 天问 - 微服务架构改造方案

## 架构概述

本项目已从单体应用改造为微服务架构，采用Spring Cloud技术栈。

### 微服务列表

| 服务名称 | 端口 | 职责 | 数据库 |
|---------|------|------|--------|
| stock-gateway | 8080 | API网关，统一入口，路由转发，JWT验证 | Redis |
| stock-auth-service | 8081 | 用户认证服务，登录注册，Token管理 | MySQL(sys_user) |
| stock-data-service | 8082 | 股票数据服务，Tushare API集成，实时数据 | Redis, RabbitMQ |
| stock-investment-service | 8083 | 投资信息服务，股票信息CRUD | MySQL(investment_info) |
| stock-correlation-service | 8084 | 省份关联分析服务，相关度计算 | MySQL(related_provinces) |

## 技术栈

- **服务框架**: Spring Boot 2.7.18
- **微服务**: Spring Cloud 2021.0.8
- **API网关**: Spring Cloud Gateway
- **数据库**: MySQL 8.0
- **缓存**: Redis
- **消息队列**: RabbitMQ
- **ORM**: MyBatis Plus
- **认证**: JWT

## 项目结构

```
stock-microservices/
├── pom.xml                          # 父POM，统一管理依赖版本
├── stock-gateway/                   # API网关
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/gateway/
│       │   ├── GatewayApplication.java
│       │   ├── config/
│       │   │   ├── CorsConfig.java
│       │   │   └── GatewayConfig.java
│       │   └── filter/
│       │       └── AuthFilter.java
│       └── resources/
│           └── application.yml
├── stock-auth-service/              # 认证服务
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/auth/
│       │   ├── AuthServiceApplication.java
│       │   ├── controller/AuthController.java
│       │   ├── service/UserService.java
│       │   ├── entity/User.java
│       │   ├── mapper/UserMapper.java
│       │   └── util/
│       │       ├── JwtUtil.java
│       │       └── PasswordUtil.java
│       └── resources/
│           └── application.yml
├── stock-data-service/              # 股票数据服务
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/data/
│       │   ├── StockDataServiceApplication.java
│       │   ├── client/TushareApiClient.java
│       │   ├── service/StockRealtimeService.java
│       │   ├── controller/StockDataController.java
│       │   ├── model/StockQuote.java
│       │   └── rabbitmq/
│       │       ├── RabbitMQConfig.java
│       │       └── StockDataProducer.java
│       └── resources/
│           └── application.yml
├── stock-investment-service/        # 投资信息服务
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/investment/
│       │   ├── InvestmentServiceApplication.java
│       │   ├── controller/InvestmentController.java
│       │   ├── service/InvestmentInfoService.java
│       │   ├── entity/InvestmentInfo.java
│       │   └── mapper/InvestmentInfoMapper.java
│       └── resources/
│           └── application.yml
├── stock-correlation-service/       # 省份关联服务
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/correlation/
│       │   ├── CorrelationServiceApplication.java
│       │   ├── controller/ProvinceCorrelationController.java
│       │   ├── service/ProvinceCorrelationService.java
│       │   ├── entity/RelatedProvince.java
│       │   └── mapper/RelatedProvinceMapper.java
│       └── resources/
│           └── application.yml
├── frontend/                        # 前端（不变）
├── sql/                            # 数据库脚本
│   └── init.sql
├── start-all.sh                    # 启动所有服务
├── stop-all.sh                     # 停止所有服务
└── README.md                       # 本文档
```

## 服务间通信

### 1. 同步通信（HTTP/REST）
- 前端 → API网关 → 各微服务
- 使用Spring Cloud Gateway路由

### 2. 异步通信（消息队列）
- stock-data-service → RabbitMQ → stock-investment-service
- 实时股票数据推送

### 3. 数据共享
- Redis：缓存、Session共享
- MySQL：各服务独立数据库表

## API路由规则

网关统一入口：`http://localhost:8080`

| 路径前缀 | 目标服务 | 说明 |
|---------|---------|------|
| /api/auth/** | stock-auth-service | 认证相关 |
| /api/stock/** | stock-data-service | 股票数据 |
| /api/investment/** | stock-investment-service | 投资信息 |
| /api/correlation/** | stock-correlation-service | 省份关联 |

## 快速开始

### 1. 环境要求

- JDK 1.8+
- Maven 3.6+
- MySQL 8.0+
- Redis 5.0+
- RabbitMQ 3.8+

### 2. 数据库初始化

```bash
mysql -u root -p < sql/init.sql
```

### 3. 配置Tushare Token

编辑 `stock-data-service/src/main/resources/application.yml`：
```yaml
tushare:
  token: your_tushare_token_here
```

### 4. 启动服务

#### 方式1：使用脚本（推荐）

```bash
# 启动所有服务
./start-all.sh

# 停止所有服务
./stop-all.sh
```

#### 方式2：手动启动

```bash
# 1. 编译所有服务
mvn clean package -DskipTests

# 2. 按顺序启动各服务
cd stock-gateway && mvn spring-boot:run &
cd stock-auth-service && mvn spring-boot:run &
cd stock-data-service && mvn spring-boot:run &
cd stock-investment-service && mvn spring-boot:run &
cd stock-correlation-service && mvn spring-boot:run &
```

### 5. 启动前端

```bash
cd frontend
npm install
npm run dev
```

### 6. 访问系统

- 前端：http://localhost:5173
- API网关：http://localhost:8080
- 默认账号：admin / 123456

## 服务健康检查

每个服务都提供健康检查端点：

```bash
# 网关
curl http://localhost:8080/actuator/health

# 认证服务
curl http://localhost:8081/actuator/health

# 股票数据服务
curl http://localhost:8082/actuator/health

# 投资信息服务
curl http://localhost:8083/actuator/health

# 省份关联服务
curl http://localhost:8084/actuator/health
```

## API示例

### 1. 用户登录

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

### 2. 获取股票实时数据

```bash
curl http://localhost:8080/api/stock/realtime/all \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 获取投资信息

```bash
curl http://localhost:8080/api/investment/list?province=京 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. 获取省份关联度

```bash
curl http://localhost:8080/api/correlation/京 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 配置说明

### 网关配置（stock-gateway/application.yml）

```yaml
server:
  port: 8080

spring:
  application:
    name: stock-gateway
  cloud:
    gateway:
      routes:
        - id: auth-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/auth/**
        - id: stock-data-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/stock/**
        - id: investment-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/investment/**
        - id: correlation-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/correlation/**
```

### 各服务端口

- Gateway: 8080
- Auth: 8081
- Stock Data: 8082
- Investment: 8083
- Correlation: 8084

## 数据库设计

### 服务与表的对应关系

| 服务 | 数据库表 |
|------|---------|
| stock-auth-service | sys_user |
| stock-investment-service | investment_info |
| stock-correlation-service | related_provinces |
| stock-data-service | 无（使用Redis缓存） |

## 监控与日志

### 日志位置

每个服务的日志都在各自的 `logs/` 目录下：

```
stock-gateway/logs/gateway.log
stock-auth-service/logs/auth.log
stock-data-service/logs/stock-data.log
stock-investment-service/logs/investment.log
stock-correlation-service/logs/correlation.log
```

### 查看日志

```bash
# 实时查看网关日志
tail -f stock-gateway/logs/gateway.log

# 查看所有服务日志
tail -f */logs/*.log
```

## 扩展与优化

### 1. 服务注册与发现

可以集成Nacos或Eureka实现服务注册与发现：

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

### 2. 配置中心

可以使用Nacos Config或Spring Cloud Config：

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

### 3. 链路追踪

集成Sleuth + Zipkin：

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-sleuth-zipkin</artifactId>
</dependency>
```

### 4. 熔断降级

使用Sentinel或Resilience4j：

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

## 常见问题

### 1. 服务启动失败

- 检查端口是否被占用
- 检查MySQL、Redis、RabbitMQ是否启动
- 查看服务日志排查错误

### 2. 网关路由不通

- 检查目标服务是否启动
- 检查网关路由配置是否正确
- 查看网关日志

### 3. JWT验证失败

- 检查Token是否过期
- 检查JWT密钥配置是否一致
- 确认请求头中包含Authorization

## 与原单体应用的对比

| 特性 | 单体应用 | 微服务架构 |
|------|---------|-----------|
| 部署 | 单个应用 | 5个独立服务 |
| 扩展性 | 整体扩展 | 按需扩展单个服务 |
| 技术栈 | 统一 | 可独立选择 |
| 故障隔离 | 差 | 好 |
| 开发效率 | 高（小团队） | 高（大团队） |
| 运维复杂度 | 低 | 中等 |

## 迁移注意事项

1. **数据库连接**：各服务使用独立的数据库连接配置
2. **共享代码**：公共类（如Result）需要在各服务中复制
3. **事务管理**：跨服务事务需要使用分布式事务方案
4. **配置管理**：各服务独立配置，注意保持一致性

## 后续优化建议

1. 引入服务注册中心（Nacos/Eureka）
2. 使用配置中心统一管理配置
3. 添加链路追踪（Sleuth+Zipkin）
4. 实现熔断降级（Sentinel）
5. 添加分布式事务支持（Seata）
6. 使用Docker容器化部署
7. 使用Kubernetes进行编排

## 联系与支持

如有问题，请查看各服务的日志文件或提交Issue。
