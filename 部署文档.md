# 天问 - 部署文档

## 一、环境准备

### 1.1 基础环境
- **JDK**: 1.8 或以上
- **Maven**: 3.6 或以上
- **Node.js**: 16.0 或以上
- **MySQL**: 8.0 或以上
- **Redis**: 5.0 或以上
- **RabbitMQ**: 3.8 或以上

### 1.2 环境安装

#### macOS 安装
```bash
# 安装 Homebrew（如果未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 MySQL
brew install mysql
brew services start mysql

# 安装 Redis
brew install redis
brew services start redis

# 安装 RabbitMQ
brew install rabbitmq
brew services start rabbitmq
```

#### Linux 安装
```bash
# MySQL
sudo apt-get install mysql-server
sudo systemctl start mysql

# Redis
sudo apt-get install redis-server
sudo systemctl start redis

# RabbitMQ
sudo apt-get install rabbitmq-server
sudo systemctl start rabbitmq-server
```

## 二、数据库初始化

### 2.1 创建数据库
```bash
# 登录MySQL
mysql -u root -p

# 执行初始化脚本
source /path/to/stock/sql/init.sql

# 或者直接执行
mysql -u root -p < sql/init.sql
```

### 2.2 验证数据
```sql
USE stock_investment;

-- 查看用户表
SELECT * FROM sys_user;

-- 查看投资信息表
SELECT COUNT(*) FROM investment_info;
```

## 三、后端部署

### 3.1 配置修改
编辑 `backend/src/main/resources/application.yml`，修改以下配置：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/stock_investment?...
    username: root
    password: your_password  # 修改为你的MySQL密码
  
  redis:
    host: localhost
    port: 6379
    password:  # 如果Redis设置了密码，在这里填写
  
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
```

### 3.2 启动后端
```bash
cd backend

# 清理并编译
mvn clean install

# 启动应用
mvn spring-boot:run

# 或者打包后运行
mvn clean package
java -jar target/stock-backend-1.0.0.jar
```

### 3.3 验证后端
访问: http://localhost:8080/api

## 四、前端部署

### 4.1 安装依赖
```bash
cd frontend

# 安装依赖
npm install

# 如果npm速度慢，可以使用淘宝镜像
npm install --registry=https://registry.npmmirror.com
```

### 4.2 启动前端
```bash
# 开发模式
npm run dev

# 生产构建
npm run build

# 预览生产构建
npm run preview
```

### 4.3 验证前端
访问: http://localhost:5173

## 五、功能测试

### 5.1 登录测试
- 访问 http://localhost:5173
- 使用默认账号登录：
  - 用户名: admin
  - 密码: 123456

### 5.2 地图功能测试
1. 登录成功后，应该看到中国地图
2. 地图上不同省份有不同颜色（根据投资数量）
3. 点击任意省份，右侧显示该省份的投资信息
4. 如果有关联省份，会在顶部显示黄色标签
5. 关联省份在地图上会高亮显示

### 5.3 API测试
```bash
# 登录接口
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'

# 获取地图数据
curl http://localhost:8080/api/investment/map/data

# 获取省份投资信息
curl http://localhost:8080/api/investment/province/北京?limit=10
```

## 六、常见问题

### 6.1 后端启动失败
**问题**: 数据库连接失败
**解决**: 
- 检查MySQL是否启动: `mysql.server status` 或 `brew services list`
- 检查数据库配置是否正确
- 检查数据库是否已创建

**问题**: Redis连接失败
**解决**:
- 检查Redis是否启动: `redis-cli ping`
- 检查Redis配置是否正确

**问题**: RabbitMQ连接失败
**解决**:
- 检查RabbitMQ是否启动: `rabbitmqctl status`
- 访问管理界面: http://localhost:15672 (guest/guest)

### 6.2 前端启动失败
**问题**: 依赖安装失败
**解决**:
- 删除 node_modules 和 package-lock.json
- 重新执行 npm install
- 使用淘宝镜像: `npm install --registry=https://registry.npmmirror.com`

**问题**: 地图不显示
**解决**:
- 检查 china.json 文件是否存在
- 检查浏览器控制台是否有错误
- 确认后端API是否正常返回数据

### 6.3 跨域问题
如果遇到跨域问题，检查：
- 后端 WebConfig 配置是否正确
- 前端 vite.config.js 代理配置是否正确

## 七、生产部署

### 7.1 后端部署
```bash
# 打包
cd backend
mvn clean package -DskipTests

# 部署到服务器
scp target/stock-backend-1.0.0.jar user@server:/path/to/deploy/

# 启动服务
nohup java -jar stock-backend-1.0.0.jar > app.log 2>&1 &
```

### 7.2 前端部署
```bash
# 构建
cd frontend
npm run build

# 部署到Nginx
cp -r dist/* /usr/share/nginx/html/

# Nginx配置示例
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 八、系统架构

### 8.1 技术栈
- **后端**: Spring Boot + MyBatis Plus + MySQL + Redis + RabbitMQ
- **前端**: Vue 3 + Element Plus + ECharts + Axios
- **认证**: JWT

### 8.2 核心功能
1. **用户认证**: JWT令牌认证，Redis缓存用户信息
2. **地图展示**: ECharts中国地图，支持省份点击交互
3. **数据查询**: 按省份查询投资信息，显示关联省份
4. **消息队列**: RabbitMQ处理投资信息更新通知
5. **缓存机制**: Redis缓存热点数据，提升查询性能

### 8.3 数据流程
```
用户登录 -> JWT认证 -> 访问首页 -> 加载地图数据
  -> 点击省份 -> 查询投资信息 -> 显示关联省份
  -> 高亮显示 -> 展示详细信息
```

## 九、性能优化

### 9.1 后端优化
- Redis缓存热点数据（10分钟过期）
- 数据库索引优化
- 连接池配置优化

### 9.2 前端优化
- 路由懒加载
- 图表按需加载
- 组件缓存

## 十、安全建议

1. **修改默认密码**: 生产环境必须修改默认账号密码
2. **JWT密钥**: 修改 application.yml 中的 jwt.secret
3. **数据库权限**: 使用专用数据库账号，限制权限
4. **HTTPS**: 生产环境启用HTTPS
5. **防火墙**: 配置防火墙规则，限制端口访问

## 十一、监控与日志

### 11.1 日志位置
- 后端日志: 控制台输出或配置文件输出
- 前端日志: 浏览器控制台

### 11.2 监控建议
- 使用 Spring Boot Actuator 监控应用健康状态
- 配置日志收集系统（如ELK）
- 监控数据库、Redis、RabbitMQ性能

## 十二、联系与支持

如有问题，请查看：
- README.md - 项目说明
- 代码注释 - 详细的代码说明
- 日志文件 - 错误信息

祝使用愉快！
