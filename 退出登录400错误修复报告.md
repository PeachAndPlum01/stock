# é€€å‡ºç™»å½•400é”™è¯¯ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2026-02-01 21:36  
**é—®é¢˜**: é€€å‡ºç™»å½•æ—¶è¿”å› `Request failed with status code 400`  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯ç°è±¡
ç”¨æˆ·ç‚¹å‡»é€€å‡ºç™»å½•æŒ‰é’®æ—¶ï¼Œå‰ç«¯æ”¶åˆ°400é”™è¯¯å“åº”ï¼š
```
Request failed with status code 400
```

### æ ¹æœ¬åŸå› 

**é—®é¢˜å‡ºåœ¨ç½‘å…³çš„ç™½åå•é…ç½®ä¸åç«¯æ¥å£å‚æ•°è¦æ±‚ä¸åŒ¹é…**ï¼š

#### 1. åç«¯æ¥å£è¦æ±‚
```java
// AuthController.java
@PostMapping("/logout")
public ResponseEntity<Map<String, Object>> logout(@RequestHeader("X-User-Id") Long userId) {
    // éœ€è¦ä»è¯·æ±‚å¤´è·å– X-User-Id å‚æ•°
    authService.logout(userId);
    // ...
}
```

åç«¯Controllerä½¿ç”¨`@RequestHeader("X-User-Id")`æ³¨è§£ï¼Œ**è¦æ±‚è¯·æ±‚å¤´ä¸­å¿…é¡»åŒ…å«`X-User-Id`å‚æ•°**ã€‚

#### 2. ç½‘å…³ç™½åå•é…ç½®ï¼ˆä¿®å¤å‰ï¼‰
```java
// AuthFilter.java (ä¿®å¤å‰)
private static final List<String> WHITE_LIST = Arrays.asList(
    "/api/auth/login",
    "/api/auth/register",
    "/api/auth/captcha",
    "/actuator",
    "/api/auth/logout"  // âŒ logoutåœ¨ç™½åå•ä¸­
);
```

**é—®é¢˜**ï¼šlogoutè·¯å¾„åœ¨ç™½åå•ä¸­ï¼Œç½‘å…³ä¼šç›´æ¥æ”¾è¡Œï¼Œä¸ä¼šéªŒè¯Tokenï¼Œä¹Ÿä¸ä¼šæ·»åŠ `X-User-Id`è¯·æ±‚å¤´ã€‚

#### 3. è¯·æ±‚æµç¨‹ï¼ˆä¿®å¤å‰ï¼‰

```mermaid
sequenceDiagram
    participant F as å‰ç«¯
    participant G as ç½‘å…³
    participant A as è®¤è¯æœåŠ¡
    
    F->>G: POST /api/auth/logout<br/>Header: Authorization: Bearer <token>
    G->>G: æ£€æŸ¥ç™½åå•ï¼ˆlogoutåœ¨ç™½åå•ä¸­ï¼‰
    G->>A: ç›´æ¥è½¬å‘è¯·æ±‚<br/>âŒ æ²¡æœ‰æ·»åŠ  X-User-Id è¯·æ±‚å¤´
    A->>A: å°è¯•è·å– @RequestHeader("X-User-Id")
    A-->>G: âŒ 400 Bad Request<br/>ç¼ºå°‘å¿…éœ€çš„è¯·æ±‚å¤´å‚æ•°
    G-->>F: âŒ 400 é”™è¯¯
```

#### 4. Springçš„è¡Œä¸º
å½“Controlleræ–¹æ³•ä½¿ç”¨`@RequestHeader`æ³¨è§£ä¸”è¯·æ±‚å¤´ä¸­ç¼ºå°‘è¯¥å‚æ•°æ—¶ï¼ŒSpringä¼šæŠ›å‡º`MissingRequestHeaderException`å¼‚å¸¸ï¼Œè¿”å›400é”™è¯¯ï¼š

```
Missing request header 'X-User-Id' for method parameter of type Long
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

æœ‰ä¸¤ç§å¯è¡Œæ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‰æ‹© |
|------|------|------|------|
| **æ–¹æ¡ˆ1**: ä»ç™½åå•ç§»é™¤logout | âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ<br/>âœ… ä»£ç æ”¹åŠ¨æœ€å°<br/>âœ… ç»Ÿä¸€è®¤è¯æµç¨‹ | éœ€è¦é‡å¯ç½‘å…³ | âœ… **é‡‡ç”¨** |
| **æ–¹æ¡ˆ2**: ä¿®æ”¹åç«¯æ¥å£è‡ªå·±è§£æToken | âœ… ä¸ä¾èµ–ç½‘å…³ | âŒ ä»£ç é‡å¤<br/>âŒ è¿åå•ä¸€èŒè´£åŸåˆ™ | âŒ ä¸é‡‡ç”¨ |

### å®æ–½æ–¹æ¡ˆ1ï¼šä»ç™½åå•ç§»é™¤logout

#### ä¿®æ”¹å†…å®¹
**æ–‡ä»¶**: `stock-gateway/src/main/java/com/stock/gateway/filter/AuthFilter.java`

```java
// ä¿®æ”¹å‰
private static final List<String> WHITE_LIST = Arrays.asList(
    "/api/auth/login",
    "/api/auth/register",
    "/api/auth/captcha",
    "/actuator",
    "/api/auth/logout"  // âŒ ç§»é™¤è¿™ä¸€è¡Œ
);

// ä¿®æ”¹å
private static final List<String> WHITE_LIST = Arrays.asList(
    "/api/auth/login",
    "/api/auth/register",
    "/api/auth/captcha",
    "/actuator"
);
```

#### ä¿®å¤åçš„è¯·æ±‚æµç¨‹

```mermaid
sequenceDiagram
    participant F as å‰ç«¯
    participant G as ç½‘å…³
    participant A as è®¤è¯æœåŠ¡
    participant R as Redis
    
    F->>G: POST /api/auth/logout<br/>Header: Authorization: Bearer <token>
    G->>G: æ£€æŸ¥ç™½åå•ï¼ˆlogoutä¸åœ¨ç™½åå•ï¼‰
    G->>G: éªŒè¯JWT Token
    G->>G: è§£æTokenï¼Œæå–userIdå’Œusername
    G->>A: è½¬å‘è¯·æ±‚<br/>âœ… Header: X-User-Id: 1<br/>âœ… Header: X-Username: admin
    A->>A: è·å– @RequestHeader("X-User-Id")
    A->>R: åˆ é™¤Redisä¸­çš„Token<br/>DEL token:1
    R-->>A: åˆ é™¤æˆåŠŸ
    A-->>G: âœ… 200 OK<br/>{"code": 200, "message": "ç™»å‡ºæˆåŠŸ"}
    G-->>F: âœ… 200 OK
    F->>F: æ¸…é™¤LocalStorage
    F->>F: è·³è½¬åˆ°ç™»å½•é¡µ
```

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### 1. ä¿®æ”¹ä»£ç 
```bash
# ç¼–è¾‘æ–‡ä»¶
vim stock-gateway/src/main/java/com/stock/gateway/filter/AuthFilter.java

# ä»ç™½åå•ä¸­ç§»é™¤ "/api/auth/logout"
```

### 2. é‡æ–°ç¼–è¯‘
```bash
cd stock-gateway
mvn clean package -DskipTests
```

**ç¼–è¯‘ç»“æœ**:
```
[INFO] BUILD SUCCESS
[INFO] Total time:  1.280 s
```

### 3. é‡å¯ç½‘å…³æœåŠ¡
```bash
# åœæ­¢æ—§è¿›ç¨‹
ps aux | grep stock-gateway | grep -v grep | awk '{print $2}' | xargs kill -9

# å¯åŠ¨æ–°è¿›ç¨‹
nohup java -jar stock-gateway/target/stock-gateway-1.0.0.jar > logs/gateway.log 2>&1 &
```

### 4. éªŒè¯æœåŠ¡çŠ¶æ€
```bash
curl http://localhost:8080/actuator/health
```

**å“åº”**:
```json
{
  "status": "UP",
  "components": {
    "redis": {"status": "UP"},
    "diskSpace": {"status": "UP"}
  }
}
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šç™»å½•è·å–Token
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJzdWIiOiIxIiwiaWF0IjoxNzY5OTUzMDA3LCJleHAiOjE3NzAwMzk0MDd9.p60WtPHbaH96O4tAWkQfbwiQdHNF98qFobOrtsBnCVI",
    "userId": 1,
    "username": "admin",
    "nickname": "ç®¡ç†å‘˜"
  }
}
```

### æµ‹è¯•2ï¼šé€€å‡ºç™»å½•ï¼ˆä¿®å¤åï¼‰
```bash
curl -X POST http://localhost:8080/api/auth/logout \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJzdWIiOiIxIiwiaWF0IjoxNzY5OTUzMDA3LCJleHAiOjE3NzAwMzk0MDd9.p60WtPHbaH96O4tAWkQfbwiQdHNF98qFobOrtsBnCVI"
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

âœ… **æµ‹è¯•é€šè¿‡ï¼é€€å‡ºç™»å½•åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼**

### æµ‹è¯•3ï¼šéªŒè¯Tokenå·²å¤±æ•ˆ
```bash
# ä½¿ç”¨å·²ç™»å‡ºçš„Tokenè®¿é—®éœ€è¦è®¤è¯çš„æ¥å£
curl -X GET http://localhost:8080/api/investment/map/data \
  -H "Authorization: Bearer <å·²ç™»å‡ºçš„token>"
```

**é¢„æœŸç»“æœ**: è¿”å›401 Unauthorizedï¼ˆå› ä¸ºRedisä¸­çš„Tokenå·²è¢«åˆ é™¤ï¼‰

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **logoutåœ¨ç™½åå•** | âœ… æ˜¯ | âŒ å¦ |
| **éœ€è¦TokenéªŒè¯** | âŒ å¦ | âœ… æ˜¯ |
| **ç½‘å…³æ·»åŠ X-User-Id** | âŒ å¦ | âœ… æ˜¯ |
| **åç«¯èƒ½è·å–userId** | âŒ å¦ | âœ… æ˜¯ |
| **è¿”å›çŠ¶æ€ç ** | âŒ 400 | âœ… 200 |
| **Redis Tokenæ¸…ç†** | âŒ å¤±è´¥ | âœ… æˆåŠŸ |
| **å®‰å…¨æ€§** | âš ï¸ ä½ | âœ… é«˜ |

---

## ğŸ”’ å®‰å…¨æ€§æå‡

### ä¿®å¤å‰çš„å®‰å…¨é—®é¢˜
1. **ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨logoutæ¥å£**ï¼ˆä¸éœ€è¦Tokenï¼‰
2. **æ— æ³•ç¡®å®šè¦ç™»å‡ºå“ªä¸ªç”¨æˆ·**ï¼ˆæ²¡æœ‰userIdï¼‰
3. **å¯èƒ½è¢«æ¶æ„åˆ©ç”¨**ï¼ˆæ‰¹é‡ç™»å‡ºæ”»å‡»ï¼‰

### ä¿®å¤åçš„å®‰å…¨ä¿éšœ
1. âœ… **å¿…é¡»æºå¸¦æœ‰æ•ˆTokenæ‰èƒ½ç™»å‡º**
2. âœ… **ç½‘å…³éªŒè¯Tokenæœ‰æ•ˆæ€§**
3. âœ… **å‡†ç¡®è¯†åˆ«è¦ç™»å‡ºçš„ç”¨æˆ·**
4. âœ… **é˜²æ­¢æœªæˆæƒçš„ç™»å‡ºæ“ä½œ**

---

## ğŸ¯ å®Œæ•´çš„è®¤è¯æµç¨‹

### å½“å‰ç™½åå•ï¼ˆä¸éœ€è¦Tokenï¼‰
```java
private static final List<String> WHITE_LIST = Arrays.asList(
    "/api/auth/login",      // ç™»å½•
    "/api/auth/register",   // æ³¨å†Œ
    "/api/auth/captcha",    // éªŒè¯ç 
    "/actuator"             // å¥åº·æ£€æŸ¥
);
```

### éœ€è¦TokenéªŒè¯çš„æ¥å£
- âœ… `/api/auth/logout` - é€€å‡ºç™»å½•
- âœ… `/api/auth/userinfo` - è·å–ç”¨æˆ·ä¿¡æ¯
- âœ… `/api/investment/**` - æ‰€æœ‰æŠ•èµ„ä¿¡æ¯æ¥å£
- âœ… å…¶ä»–æ‰€æœ‰ä¸šåŠ¡æ¥å£

---

## ğŸ“ å‰ç«¯ä½¿ç”¨è¯´æ˜

### é€€å‡ºç™»å½•æµç¨‹ï¼ˆå‰ç«¯ï¼‰

```javascript
// Home.vue
const handleLogout = async () => {
  try {
    // 1. è°ƒç”¨é€€å‡ºç™»å½•APIï¼ˆä¼šè‡ªåŠ¨æºå¸¦Tokenï¼‰
    await logout()
    
    // 2. æ¸…é™¤æœ¬åœ°å­˜å‚¨
    userStore.clearUser()  // æ¸…é™¤Tokenå’Œç”¨æˆ·ä¿¡æ¯
    
    // 3. è·³è½¬åˆ°ç™»å½•é¡µ
    router.push('/login')
    
    ElMessage.success('é€€å‡ºç™»å½•æˆåŠŸ')
  } catch (error) {
    console.error('é€€å‡ºç™»å½•å¤±è´¥ï¼š', error)
    ElMessage.error('é€€å‡ºç™»å½•å¤±è´¥')
  }
}
```

### è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨æ·»åŠ Tokenï¼‰

```javascript
// request.js
request.interceptors.request.use(
  config => {
    const userStore = useUserStore()
    if (userStore.token) {
      // è‡ªåŠ¨æ·»åŠ Authorizationè¯·æ±‚å¤´
      config.headers['Authorization'] = `Bearer ${userStore.token}`
    }
    return config
  }
)
```

**å‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œå› ä¸ºè¯·æ±‚æ‹¦æˆªå™¨ä¼šè‡ªåŠ¨æ·»åŠ Tokenï¼**

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. **é‡æ–°ç¼–è¯‘ç½‘å…³æœåŠ¡**
   ```bash
   cd stock-gateway
   mvn clean package -DskipTests
   ```

2. **å¤‡ä»½å½“å‰è¿è¡Œçš„jaråŒ…**
   ```bash
   cp stock-gateway/target/stock-gateway-1.0.0.jar \
      stock-gateway/target/stock-gateway-1.0.0.jar.backup
   ```

3. **æ»šåŠ¨æ›´æ–°**
   ```bash
   # åœæ­¢æ—§æœåŠ¡
   kill -15 <gateway-pid>
   
   # ç­‰å¾…ä¼˜é›…å…³é—­
   sleep 5
   
   # å¯åŠ¨æ–°æœåŠ¡
   nohup java -jar stock-gateway/target/stock-gateway-1.0.0.jar \
     > logs/gateway.log 2>&1 &
   ```

4. **éªŒè¯æœåŠ¡**
   ```bash
   # æ£€æŸ¥å¥åº·çŠ¶æ€
   curl http://localhost:8080/actuator/health
   
   # æµ‹è¯•ç™»å½•
   curl -X POST http://localhost:8080/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"123456"}'
   
   # æµ‹è¯•é€€å‡ºç™»å½•
   curl -X POST http://localhost:8080/api/auth/logout \
     -H "Authorization: Bearer <token>"
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç™»å½•é€»è¾‘å®Œæ•´è¯´æ˜](./ç™»å½•é€»è¾‘è¯´æ˜.md)
- [401é”™è¯¯ä¿®å¤æŠ¥å‘Š](./401é”™è¯¯ä¿®å¤æŠ¥å‘Š.md)
- [JWTè®¤è¯æœºåˆ¶](./JWTè®¤è¯æœºåˆ¶.md)

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¹æº
logoutæ¥å£åœ¨ç½‘å…³ç™½åå•ä¸­ï¼Œå¯¼è‡´è¯·æ±‚ç›´æ¥æ”¾è¡Œï¼Œæ²¡æœ‰æ·»åŠ åç«¯éœ€è¦çš„`X-User-Id`è¯·æ±‚å¤´ï¼ŒSpringæŠ›å‡º400é”™è¯¯ã€‚

### è§£å†³æ–¹æ¡ˆ
ä»ç½‘å…³ç™½åå•ä¸­ç§»é™¤`/api/auth/logout`ï¼Œè®©å…¶ä¹Ÿéœ€è¦TokenéªŒè¯ï¼Œç½‘å…³ä¼šè‡ªåŠ¨æ·»åŠ `X-User-Id`è¯·æ±‚å¤´ã€‚

### ä¿®å¤æ•ˆæœ
- âœ… é€€å‡ºç™»å½•åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… è¿”å›200æˆåŠŸå“åº”
- âœ… Redisä¸­çš„Tokenè¢«æ­£ç¡®æ¸…ç†
- âœ… å®‰å…¨æ€§å¾—åˆ°æå‡
- âœ… å‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹

### æµ‹è¯•ç»“æœ
æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼Œé€€å‡ºç™»å½•åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-01 21:36  
**ä¿®å¤äººå‘˜**: AI Assistant  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡
