input {
  # 从文件读取日志
  file {
    path => "/var/log/stock/*/*.log"
    type => "application"
    codec => multiline {
      pattern => "^\d{4}-\d{2}-\d{2}"
      negate => true
      what => "previous"
    }
    start_position => "beginning"
  }
}

filter {
  # 解析应用日志
  if [type] == "application" {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{DATA:thread}\] %{LOGLEVEL:level} %{DATA:logger} - %{GREEDYDATA:message}"
      }
      overwrite => ["message"]
    }

    # 提取TraceId和SpanId
    grok {
      match => {
        "message" => "TraceId: %{DATA:traceId} SpanId: %{DATA:spanId}"
      }
    }

    # 解析时间戳
    date {
      match => ["timestamp", "yyyy-MM-dd HH:mm:ss.SSS"]
      target => "@timestamp"
      timezone => "Asia/Shanghai"
    }

    # 添加服务名称
    if [path] =~ "gateway" {
      mutate { add_field => { "service" => "gateway" } }
    } else if [path] =~ "auth-service" {
      mutate { add_field => { "service" => "auth-service" } }
    } else if [path] =~ "data-service" {
      mutate { add_field => { "service" => "data-service" } }
    } else if [path] =~ "investment-service" {
      mutate { add_field => { "service" => "investment-service" } }
    } else if [path] =~ "correlation-service" {
      mutate { add_field => { "service" => "correlation-service" } }
    }

    # 移除不需要的字段
    mutate {
      remove_field => ["path", "host"]
    }
  }
}

output {
  # 输出到Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "stock-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # 调试输出（可选）
  # stdout { codec => rubydebug }
}
