# ğŸ”§ 401 Unauthorized é”™è¯¯ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**ï¼š2026-02-01 21:10  
**é—®é¢˜çŠ¶æ€**ï¼šâœ… å·²è§£å†³

---

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡

ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œè®¿é—®å…¶ä»–æ¥å£æ—¶è¿”å› **401 Unauthorized** é”™è¯¯ï¼š

```
Failed to load resource: the server responded with a status of 401 (Unauthorized)
AxiosError: Request failed with status code 401
```

**å—å½±å“çš„æ¥å£**ï¼š
- `/api/investment/map/data` - åœ°å›¾æ•°æ®æ¥å£
- `/api/auth/logout` - ç™»å‡ºæ¥å£
- æ‰€æœ‰éœ€è¦è®¤è¯çš„æ¥å£

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

**JWTç­¾åéªŒè¯å¤±è´¥**ï¼šè®¤è¯æœåŠ¡ç”ŸæˆTokenæ—¶ä½¿ç”¨çš„å¯†é’¥å’Œç½‘å…³éªŒè¯Tokenæ—¶ä½¿ç”¨çš„å¯†é’¥**ç”Ÿæˆæ–¹å¼ä¸ä¸€è‡´**ã€‚

### è¯¦ç»†åˆ†æ

#### 1. è®¤è¯æœåŠ¡ï¼ˆTokenç”Ÿæˆï¼‰

**æ–‡ä»¶**ï¼š`stock-auth-service/src/main/java/com/stock/auth/util/JwtUtil.java`

```java
// ä½¿ç”¨ Keys.hmacShaKeyFor() ç”Ÿæˆå¯†é’¥
Key key = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));

return Jwts.builder()
        .setClaims(claims)
        .setSubject(String.valueOf(userId))
        .setIssuedAt(now)
        .setExpiration(expiryDate)
        .signWith(key, SignatureAlgorithm.HS256)  // âœ… ä½¿ç”¨ Key å¯¹è±¡ç­¾å
        .compact();
```

#### 2. ç½‘å…³ï¼ˆTokenéªŒè¯ - ä¿®å¤å‰ï¼‰

**æ–‡ä»¶**ï¼š`stock-gateway/src/main/java/com/stock/gateway/filter/AuthFilter.java`

```java
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ byte[] ä½œä¸ºå¯†é’¥
Claims claims = Jwts.parserBuilder()
        .setSigningKey(jwtSecret.getBytes())  // âŒ é—®é¢˜æ‰€åœ¨
        .build()
        .parseClaimsJws(token)
        .getBody();
```

#### 3. é”™è¯¯æ—¥å¿—

```
âŒ AuthFilter - TokenéªŒè¯å¤±è´¥: JWT signature does not match locally computed signature. 
JWT validity cannot be asserted and should not be trusted.

io.jsonwebtoken.security.SignatureException: JWT signature does not match locally computed signature.
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

ä¿®æ”¹ç½‘å…³çš„ `AuthFilter.java`ï¼Œä½¿ç”¨ä¸è®¤è¯æœåŠ¡**ç›¸åŒçš„å¯†é’¥ç”Ÿæˆæ–¹å¼**ï¼š

#### 1. æ·»åŠ å¯¼å…¥

```java
import io.jsonwebtoken.security.Keys;
import java.nio.charset.StandardCharsets;
import java.security.Key;
```

#### 2. ä¿®æ”¹TokenéªŒè¯é€»è¾‘

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Keys.hmacShaKeyFor() ç”Ÿæˆå¯†é’¥
Key key = Keys.hmacShaKeyFor(jwtSecret.getBytes(StandardCharsets.UTF_8));

Claims claims = Jwts.parserBuilder()
        .setSigningKey(key)  // âœ… ä½¿ç”¨ Key å¯¹è±¡
        .build()
        .parseClaimsJws(token)
        .getBody();
```

### ä¿®æ”¹çš„æ–‡ä»¶

- `/Users/lifeng/Desktop/code/stock/stock-gateway/src/main/java/com/stock/gateway/filter/AuthFilter.java`

---

## ğŸ§ª éªŒè¯ç»“æœ

### æµ‹è¯•1ï¼šç™»å½•æ¥å£

**è¯·æ±‚**ï¼š
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

**å“åº”**ï¼šâœ… æˆåŠŸ
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "userId": 1,
    "username": "admin",
    "nickname": "ç®¡ç†å‘˜",
    "token": "eyJhbGciOiJIUzI1NiJ9..."
  }
}
```

---

### æµ‹è¯•2ï¼šTokenéªŒè¯

**è¯·æ±‚**ï¼š
```bash
curl -X GET "http://localhost:8080/api/investment/map/data" \
  -H "Authorization: Bearer <TOKEN>"
```

**ç½‘å…³æ—¥å¿—**ï¼šâœ… TokenéªŒè¯æˆåŠŸ
```
ğŸ” AuthFilter - è¯·æ±‚è·¯å¾„: /api/investment/map/data
ğŸ”‘ AuthFilter - Token: eyJhbGciOiJIUzI1NiJ9...
âœ… AuthFilter - TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·: admin (ID: 1)
```

**ç»“æœ**ï¼š
- âœ… ä¸å†è¿”å› 401 é”™è¯¯
- âœ… TokenéªŒè¯é€šè¿‡
- âœ… è¯·æ±‚æˆåŠŸè½¬å‘åˆ°åç«¯æœåŠ¡

---

## ğŸ¯ å…¶ä»–ä¿®å¤

### 1. ç™½åå•é…ç½®ä¼˜åŒ–

æ·»åŠ  `/api/auth/logout` åˆ°ç™½åå•ï¼Œå…è®¸ç”¨æˆ·ç™»å‡ºï¼š

```java
private static final List<String> WHITE_LIST = Arrays.asList(
        "/api/auth/login",
        "/api/auth/register",
        "/api/auth/captcha",
        "/actuator",
        "/api/auth/logout"  // âœ… æ–°å¢
);
```

### 2. æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `AuthFilter` ä¸­æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥ï¼š

```java
System.out.println("ğŸ” AuthFilter - è¯·æ±‚è·¯å¾„: " + path);
System.out.println("ğŸ”‘ AuthFilter - Token: " + token.substring(0, 20) + "...");
System.out.println("âœ… AuthFilter - TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·: " + username);
System.out.println("âŒ AuthFilter - TokenéªŒè¯å¤±è´¥: " + e.getMessage());
```

---

## ğŸ“ é‡è¦è¯´æ˜

### âš ï¸ éœ€è¦é‡æ–°ç™»å½•

ä¿®å¤åï¼Œ**ä¹‹å‰ç”Ÿæˆçš„Tokenå°†æ— æ³•ä½¿ç”¨**ï¼Œå› ä¸ºï¼š

1. æ—§Tokenæ˜¯ç”¨æ—§çš„å¯†é’¥ç”Ÿæˆæ–¹å¼åˆ›å»ºçš„
2. æ–°çš„éªŒè¯é€»è¾‘ä½¿ç”¨äº†ä¸åŒçš„å¯†é’¥ç”Ÿæˆæ–¹å¼
3. ç­¾åä¸åŒ¹é…ï¼ŒéªŒè¯ä¼šå¤±è´¥

**è§£å†³æ–¹æ³•**ï¼š
- åœ¨æµè§ˆå™¨ä¸­**æ¸…é™¤LocalStorage**
- **é‡æ–°ç™»å½•**è·å–æ–°çš„Token
- æˆ–è€…ç›´æ¥åˆ·æ–°é¡µé¢ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

---

## ğŸ”‘ æŠ€æœ¯è¦ç‚¹

### JWTå¯†é’¥ç”Ÿæˆçš„ä¸¤ç§æ–¹å¼

#### æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨byte[]ï¼ˆä¸æ¨èï¼‰

```java
.setSigningKey(secret.getBytes())
```

**é—®é¢˜**ï¼š
- å¯†é’¥é•¿åº¦å¯èƒ½ä¸ç¬¦åˆHMAC-SHA256è¦æ±‚ï¼ˆè‡³å°‘256ä½ï¼‰
- å®‰å…¨æ€§è¾ƒä½
- ä¸æ ‡å‡†åº“ä¸å…¼å®¹

#### æ–¹å¼2ï¼šä½¿ç”¨Keys.hmacShaKeyFor()ï¼ˆæ¨èï¼‰âœ…

```java
Key key = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
.setSigningKey(key)
```

**ä¼˜ç‚¹**ï¼š
- è‡ªåŠ¨éªŒè¯å¯†é’¥é•¿åº¦
- ç¬¦åˆHMAC-SHA256æ ‡å‡†
- æ›´å®‰å…¨
- ä¸JJWTåº“å®Œå…¨å…¼å®¹

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **ç™»å½•** | âœ… æˆåŠŸ | âœ… æˆåŠŸ |
| **Tokenç”Ÿæˆ** | âœ… æˆåŠŸ | âœ… æˆåŠŸ |
| **TokenéªŒè¯** | âŒ å¤±è´¥ï¼ˆ401ï¼‰ | âœ… æˆåŠŸ |
| **è®¿é—®å—ä¿æŠ¤æ¥å£** | âŒ å¤±è´¥ï¼ˆ401ï¼‰ | âœ… æˆåŠŸ |
| **å¯†é’¥ç”Ÿæˆæ–¹å¼** | âŒ ä¸ä¸€è‡´ | âœ… ä¸€è‡´ |
| **é”™è¯¯æ—¥å¿—** | SignatureException | âœ… æ— é”™è¯¯ |

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. é‡å¯ç½‘å…³

```bash
cd /Users/lifeng/Desktop/code/stock

# åœæ­¢æ—§çš„ç½‘å…³è¿›ç¨‹
ps aux | grep "stock-gateway" | grep -v grep | awk '{print $2}' | xargs kill

# é‡æ–°ç¼–è¯‘å¹¶å¯åŠ¨
cd stock-gateway
mvn clean package -DskipTests
nohup java -jar target/stock-gateway-1.0.0.jar > ../logs/gateway.log 2>&1 &
```

### 2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

**Chrome/Edge**ï¼š
1. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
2. ç‚¹å‡» `Application` æ ‡ç­¾
3. å±•å¼€ `Local Storage`
4. å³é”®ç‚¹å‡» `http://localhost:5173`
5. é€‰æ‹© `Clear`

**æˆ–è€…ç›´æ¥åœ¨Consoleä¸­æ‰§è¡Œ**ï¼š
```javascript
localStorage.clear()
location.reload()
```

### 3. é‡æ–°ç™»å½•

1. è®¿é—®ï¼šhttp://localhost:5173
2. è¾“å…¥ç”¨æˆ·åï¼š`admin`
3. è¾“å…¥å¯†ç ï¼š`123456`
4. ç‚¹å‡»ç™»å½•
5. âœ… ç™»å½•æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸è®¿é—®æ‰€æœ‰åŠŸèƒ½

---

## ğŸ” é—®é¢˜æ’æŸ¥æ–¹æ³•

### 1. æŸ¥çœ‹ç½‘å…³æ—¥å¿—

```bash
tail -f /Users/lifeng/Desktop/code/stock/logs/gateway.log
```

**å…³é”®æ—¥å¿—**ï¼š
```
ğŸ” AuthFilter - è¯·æ±‚è·¯å¾„: /api/investment/map/data
ğŸ”‘ AuthFilter - Token: eyJhbGciOiJIUzI1NiJ9...
âœ… AuthFilter - TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·: admin (ID: 1)
```

### 2. æµ‹è¯•TokenéªŒè¯

```bash
# 1. ç™»å½•è·å–Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}' \
  | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['token'])")

# 2. ä½¿ç”¨Tokenè®¿é—®æ¥å£
curl -X GET "http://localhost:8080/api/investment/map/data" \
  -H "Authorization: Bearer $TOKEN"
```

### 3. æ£€æŸ¥Redisä¸­çš„Token

```bash
redis-cli
> KEYS token:*
> GET token:1
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [JWTå®˜æ–¹æ–‡æ¡£](https://jwt.io/)
- [JJWTåº“æ–‡æ¡£](https://github.com/jwtk/jjwt)
- [Spring Cloud Gatewayæ–‡æ¡£](https://spring.io/projects/spring-cloud-gateway)

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### 1. JWTå¯†é’¥ç®¡ç†

- âœ… ä½¿ç”¨ç»Ÿä¸€çš„å¯†é’¥ç”Ÿæˆæ–¹å¼
- âœ… å¯†é’¥é•¿åº¦è‡³å°‘256ä½ï¼ˆHMAC-SHA256ï¼‰
- âœ… åœ¨é…ç½®æ–‡ä»¶ä¸­ç»Ÿä¸€ç®¡ç†å¯†é’¥
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡

### 2. å¾®æœåŠ¡è®¤è¯

- âœ… ç½‘å…³ç»Ÿä¸€å¤„ç†è®¤è¯
- âœ… åç«¯æœåŠ¡ä¿¡ä»»ç½‘å…³ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯
- âœ… ä½¿ç”¨è¯·æ±‚å¤´ä¼ é€’ç”¨æˆ·IDå’Œç”¨æˆ·å
- âœ… ç™½åå•é…ç½®è¦å®Œæ•´

### 3. é—®é¢˜æ’æŸ¥

- âœ… æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… ä½¿ç”¨curlæµ‹è¯•æ¥å£
- âœ… æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯å †æ ˆ
- âœ… å¯¹æ¯”ç”Ÿæˆå’ŒéªŒè¯çš„é€»è¾‘

---

## âœ… ä¿®å¤ç¡®è®¤

- [x] JWTç­¾åéªŒè¯é—®é¢˜å·²è§£å†³
- [x] Tokenå¯ä»¥æ­£å¸¸éªŒè¯
- [x] 401é”™è¯¯å·²æ¶ˆé™¤
- [x] ç™½åå•é…ç½®å·²ä¼˜åŒ–
- [x] è°ƒè¯•æ—¥å¿—å·²æ·»åŠ 
- [x] æ–‡æ¡£å·²æ›´æ–°

---

**ä¿®å¤äººå‘˜**ï¼šAI Assistant  
**ä¿®å¤æ—¥æœŸ**ï¼š2026-02-01  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å®Œæˆå¹¶éªŒè¯é€šè¿‡
