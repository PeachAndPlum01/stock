# 项目结构说明

## 目录结构

```
stock/
├── README.md                        # 项目说明文档
├── pom.xml                          # Maven父POM
├── docker-compose.yml               # Docker编排文件
├── .env.template                    # 环境变量模板
│
├── docs/                           # 文档目录
│   ├── nacos-mysql-init.sql        # Nacos数据库初始化脚本
│   ├── TUSHARE_API_GUIDE.md        # Tushare API使用指南
│   ├── SPRING-CLOUD-COMPONENTS.md  # Spring Cloud组件集成指南
│   └── INTEGRATION-SUMMARY.md      # 组件集成总结
│
├── scripts/                        # 脚本目录
│   ├── backup-mysql.sh            # MySQL全量备份脚本
│   ├── deploy-technical-components.sh  # 技术组件一键部署脚本
│   ├── deploy.sh                  # 全量部署脚本
│   ├── init-db-users.sh           # 初始化数据库用户脚本
│   ├── mysql-master.cnf           # MySQL主库配置
│   ├── mysql-slave.cnf            # MySQL从库配置
│   ├── rabbitmq-join-cluster.sh   # RabbitMQ集群加入脚本
│   ├── redis-sentinel.conf        # Redis哨兵配置
│   └── restore-mysql.sh           # MySQL恢复脚本
│
├── stock-common/                   # 公共模块
│   ├── pom.xml
│   └── src/main/java/com/stock/common/
│       ├── result/                 # 统一响应结果
│       ├── feign/                  # Feign客户端接口
│       ├── dto/                    # 数据传输对象
│       ├── entity/                 # 公共实体
│       ├── enums/                  # 枚举类
│       ├── exception/              # 异常类
│       └── utils/                  # 工具类
│
├── stock-gateway/                  # API网关服务
│   ├── Dockerfile
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/gateway/
│       └── resources/
│           ├── application.yml
│           └── bootstrap.yml
│
├── stock-auth-service/             # 认证服务
│   ├── Dockerfile
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/auth/
│       │   ├── controller/        # 控制器
│       │   ├── service/           # 业务逻辑
│       │   ├── mapper/            # 数据访问
│       │   ├── entity/            # 实体类
│       │   └── config/            # 配置类
│       └── resources/
│           ├── application.yml
│           └── mapper/            # MyBatis映射文件
│
├── stock-data-service/             # 股票数据服务
│   ├── Dockerfile
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/data/
│       │   ├── controller/
│       │   ├── service/
│       │   ├── config/
│       │   └── scheduler/         # 定时任务
│       └── resources/
│           └── application.yml
│
├── stock-investment-service/       # 投资信息服务
│   ├── Dockerfile
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/investment/
│       │   ├── controller/
│       │   ├── service/
│       │   ├── mapper/
│       │   └── entity/
│       └── resources/
│           ├── application.yml
│           └── mapper/
│
├── stock-correlation-service/      # 省份关联服务
│   ├── Dockerfile
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/correlation/
│       │   ├── controller/
│       │   ├── service/
│       │   ├── mapper/
│       │   └── entity/
│       └── resources/
│           ├── application.yml
│           └── mapper/
│
├── stock-admin-server/             # Spring Boot Admin监控服务
│   ├── Dockerfile
│   ├── pom.xml
│   └── src/main/
│       ├── java/com/stock/admin/
│       │   ├── AdminServerApplication.java
│       │   └── config/            # 安全配置
│       └── resources/
│           ├── application.yml
│           └── application-docker.yml
│
└── frontend/                       # 前端项目
    ├── Dockerfile
    ├── nginx.conf
    ├── package.json
    ├── vite.config.js
    ├── index.html
    └── src/
        ├── main.js
        ├── App.vue
        ├── router/                # 路由配置
        ├── views/                 # 页面组件
        ├── components/            # 公共组件
        ├── api/                   # API接口
        └── utils/                 # 工具函数
```

## 服务说明

### 1. stock-common（公共模块）
- 统一响应结果封装
- Feign客户端接口定义
- 公共实体类和DTO
- 工具类和常量

### 2. stock-gateway（API网关）
- 统一入口
- 路由转发
- JWT验证
- 跨域处理
- 集成Nacos服务发现

### 3. stock-auth-service（认证服务）
- 用户注册登录
- JWT Token生成与验证
- 用户信息管理
- 权限控制

### 4. stock-data-service（股票数据服务）
- Tushare API集成
- 实时股票数据获取
- 历史数据查询
- 数据定时更新
- WebSocket推送

### 5. stock-investment-service（投资信息服务）
- 投资记录管理
- 收益统计分析
- 持仓信息查询
- 投资报表生成

### 6. stock-correlation-service（省份关联服务）
- 省份与股票关联度计算
- 地域投资分析
- 关联度排名

### 7. stock-admin-server（监控服务）
- 微服务健康监控
- JVM性能监控
- 日志查看
- 服务管理

## 技术架构

### Spring Cloud组件
- **Nacos**: 服务注册与发现、配置中心
- **OpenFeign**: 声明式HTTP客户端
- **Sentinel**: 流量控制、熔断降级
- **Gateway**: API网关
- **LoadBalancer**: 负载均衡
- **Sleuth + Zipkin**: 分布式链路追踪
- **Spring Boot Admin**: 微服务监控
- **Seata**: 分布式事务
- **Jasypt**: 配置加密

### 数据存储
- **MySQL**: 主数据库
- **Redis**: 缓存、Session
- **RabbitMQ**: 消息队列

### 开发工具
- **MyBatis Plus**: ORM框架
- **JWT**: 认证令牌
- **Lombok**: 简化代码
- **Fastjson**: JSON处理

## 端口分配

| 服务 | 端口 | 说明 |
|------|------|------|
| Frontend | 80 | 前端应用 |
| Gateway | 8080 | API网关 |
| Auth Service | 8081 | 认证服务 |
| Data Service | 8082 | 数据服务 |
| Investment Service | 8083 | 投资服务 |
| Correlation Service | 8084 | 关联服务 |
| Admin Server | 8090 | 监控服务 |
| Nacos | 8848 | 服务注册中心 |
| Zipkin | 9411 | 链路追踪 |
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |
| RabbitMQ | 5672 | 消息队列 |
| RabbitMQ Management | 15672 | 管理界面 |

## 配置文件说明

### application.yml
每个服务的主配置文件，包含：
- 服务端口
- 数据库连接
- Redis配置
- 业务配置

### bootstrap.yml
用于Nacos配置中心，包含：
- 服务名称
- Nacos地址
- 配置文件格式

### docker-compose.yml
Docker编排配置，定义：
- 所有服务容器
- 网络配置
- 数据卷挂载
- 环境变量

## 开发规范

### 代码结构
```
controller/     # 控制器层，处理HTTP请求
service/        # 业务逻辑层
mapper/         # 数据访问层
entity/         # 实体类
dto/            # 数据传输对象
config/         # 配置类
```

### 命名规范
- 类名：大驼峰（PascalCase）
- 方法名：小驼峰（camelCase）
- 常量：全大写下划线分隔（UPPER_SNAKE_CASE）
- 包名：全小写

### 响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1234567890
}
```

## 部署说明

### Docker部署（推荐）
```bash
# 1. 配置环境变量
cp .env.template .env

# 2. 初始化Nacos数据库
docker-compose up -d mysql
sleep 30
docker exec -i stock-mysql mysql -uroot -proot < docs/nacos-mysql-init.sql

# 3. 启动所有服务
docker-compose up -d --build
```

### 本地开发
```bash
# 1. 启动基础设施
docker-compose up -d mysql redis rabbitmq nacos

# 2. 启动微服务
cd stock-gateway && mvn spring-boot:run &
cd stock-auth-service && mvn spring-boot:run &
# ... 其他服务

# 3. 启动前端
cd frontend && npm run dev
```

## 监控与日志

### 监控服务
- **Spring Boot Admin**: http://localhost:8090 (admin/admin123)
- **Zipkin链路追踪**: http://localhost:9411
- **Nacos控制台**: http://localhost:8848/nacos (nacos/nacos)
- **RabbitMQ管理**: http://localhost:15672 (guest/guest)

### 日志位置
- 容器内：`/app/logs/`
- 宿主机：`/var/log/stock/`

### 健康检查
- Gateway: http://localhost:8080/actuator/health
- Auth Service: http://localhost:8081/actuator/health
- 其他服务类似

### Nacos控制台
- URL: http://localhost:8848/nacos
- 用户名: nacos
- 密码: nacos

## 常见问题

1. **服务无法启动**：检查端口是否被占用
2. **无法连接数据库**：确认MySQL容器已启动
3. **Nacos注册失败**：检查Nacos服务状态
4. **前端无法访问**：检查Gateway是否正常运行

## 维护建议

1. 定期备份数据库
2. 监控服务健康状态
3. 及时更新依赖版本
4. 定期清理日志文件
5. 关注Nacos配置变更