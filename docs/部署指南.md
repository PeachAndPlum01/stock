# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

**æœ€ä½é…ç½®**ï¼ˆå°è§„æ¨¡éƒ¨ç½²ï¼‰:
- CPU: 8æ ¸
- å†…å­˜: 16GB
- ç£ç›˜: 200GB SSD
- ç½‘ç»œ: 100Mbps

**æ¨èé…ç½®**ï¼ˆä¸­è§„æ¨¡éƒ¨ç½²ï¼‰:
- CPU: 16æ ¸
- å†…å­˜: 32GB
- ç£ç›˜: 500GB SSD
- ç½‘ç»œ: 1Gbps

### 2. è½¯ä»¶è¦æ±‚

- Docker: >= 20.10
- Docker Compose: >= 2.0
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+

### 3. ç½‘ç»œè¦æ±‚

**å¼€æ”¾ç«¯å£**:
- 80: HTTP (Nginx)
- 443: HTTPS (Nginx)
- 8848: Nacos
- 9090: Prometheus
- 3000: Grafana
- 5601: Kibana

**å†…éƒ¨ç«¯å£**ï¼ˆä»…å†…ç½‘è®¿é—®ï¼‰:
- 3306-3308: MySQL
- 6379-6381: Redis
- 5672-5674: RabbitMQ
- 8080-8280: Gateway
- 8081-8181: Auth Service
- 8082-8182: Data Service
- 8083-8183: Investment Service
- 8084-8184: Correlation Service

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: å‡†å¤‡ç¯å¢ƒ

```bash
# 1. å®‰è£…Dockerå’ŒDocker Compose
curl -fsSL https://get.docker.com | bash
sudo usermod -aG docker $USER

# 2. åˆ›å»ºæ•°æ®ç›®å½•
sudo mkdir -p /opt/stock/docker-data/{mysql,redis,rabbitmq,nacos,elasticsearch}
sudo mkdir -p /backup/{mysql,redis}
sudo mkdir -p /var/log/stock

# 3. è®¾ç½®æƒé™
sudo chown -R $USER:$USER /opt/stock
sudo chown -R $USER:$USER /backup
sudo chown -R $USER:$USER /var/log/stock
```

### æ­¥éª¤2: é…ç½®ç¯å¢ƒå˜é‡

```bash
# 1. å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cd /path/to/stock
cp .env.template .env

# 2. ç”Ÿæˆå¼ºå¯†ç 
# MySQL Rootå¯†ç 
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)

# Rediså¯†ç 
REDIS_PASSWORD=$(openssl rand -base64 32)

# RabbitMQå¯†ç 
RABBITMQ_PASSWORD=$(openssl rand -base64 32)

# JWTå¯†é’¥ï¼ˆ256ä½ï¼‰
JWT_SECRET=$(openssl rand -base64 32)

# JasyptåŠ å¯†å¯†é’¥
JASYPT_PASSWORD=$(openssl rand -base64 32)

# 3. ç¼–è¾‘.envæ–‡ä»¶ï¼Œå¡«å…¥ç”Ÿæˆçš„å¯†ç 
vim .env
```

**é‡è¦**: å°†ç”Ÿæˆçš„å¯†ç ä¿å­˜åˆ°å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚HashiCorp Vaultï¼‰ï¼

### æ­¥éª¤3: é…ç½®SSLè¯ä¹¦

```bash
# æ–¹å¼1: ä½¿ç”¨Let's Encryptï¼ˆæ¨èï¼‰
sudo apt install certbot
sudo certbot certonly --standalone -d your-domain.com

# å¤åˆ¶è¯ä¹¦
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem config/ssl/cert.pem
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem config/ssl/key.pem

# æ–¹å¼2: ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼ˆä»…æµ‹è¯•ï¼‰
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout config/ssl/key.pem \
  -out config/ssl/cert.pem \
  -subj "/CN=your-domain.com"
```

### æ­¥éª¤4: åˆå§‹åŒ–æ•°æ®åº“

```bash
# 1. å¯åŠ¨MySQL
docker-compose -f docker-compose.prod.yml up -d mysql-master mysql-slave-1 mysql-slave-2

# 2. ç­‰å¾…MySQLå¯åŠ¨
sleep 30

# 3. åˆå§‹åŒ–æ•°æ®åº“ç”¨æˆ·
./scripts/init-db-users.sh

# 4. é…ç½®ä¸»ä»å¤åˆ¶
docker exec -it stock-mysql-master mysql -uroot -p${MYSQL_ROOT_PASSWORD} <<EOF
CREATE USER 'repl'@'%' IDENTIFIED BY 'replication_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
SHOW MASTER STATUS;
EOF

# è®°å½•Fileå’ŒPositionå€¼ï¼Œç„¶ååœ¨ä»åº“æ‰§è¡Œï¼š
docker exec -it stock-mysql-slave-1 mysql -uroot -p${MYSQL_ROOT_PASSWORD} <<EOF
CHANGE MASTER TO
  MASTER_HOST='mysql-master',
  MASTER_USER='repl',
  MASTER_PASSWORD='replication_password',
  MASTER_LOG_FILE='mysql-bin.000001',  # æ›¿æ¢ä¸ºå®é™…å€¼
  MASTER_LOG_POS=154;                   # æ›¿æ¢ä¸ºå®é™…å€¼
START SLAVE;
SHOW SLAVE STATUS\G
EOF

# å¯¹slave-2æ‰§è¡Œç›¸åŒæ“ä½œ
```

### æ­¥éª¤5: å¯åŠ¨ä¸­é—´ä»¶

```bash
# 1. å¯åŠ¨Redisé›†ç¾¤
docker-compose -f docker-compose.prod.yml up -d \
  redis-master redis-slave-1 redis-slave-2 \
  redis-sentinel-1 redis-sentinel-2 redis-sentinel-3

# 2. å¯åŠ¨RabbitMQé›†ç¾¤
docker-compose -f docker-compose.prod.yml up -d \
  rabbitmq-1 rabbitmq-2 rabbitmq-3

# 3. å¯åŠ¨Nacos
docker-compose -f docker-compose.prod.yml up -d nacos

# 4. ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 60

# 5. éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

### æ­¥éª¤6: å¯åŠ¨ç›‘æ§ç»„ä»¶

```bash
# 1. å¯åŠ¨Prometheuså’ŒGrafana
docker-compose -f docker-compose.prod.yml up -d \
  prometheus grafana alertmanager

# 2. å¯åŠ¨ELK
docker-compose -f docker-compose.prod.yml up -d \
  elasticsearch logstash kibana

# 3. å¯åŠ¨Zipkin
docker-compose -f docker-compose.prod.yml up -d zipkin

# 4. ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 60
```

### æ­¥éª¤7: å¯åŠ¨ä¸šåŠ¡æœåŠ¡

```bash
# 1. æ„å»ºé•œåƒ
docker-compose -f docker-compose.prod.yml build

# 2. å¯åŠ¨Admin Server
docker-compose -f docker-compose.prod.yml up -d stock-admin-server

# 3. å¯åŠ¨Gatewayï¼ˆ3å®ä¾‹ï¼‰
docker-compose -f docker-compose.prod.yml up -d \
  stock-gateway-1 stock-gateway-2 stock-gateway-3

# 4. å¯åŠ¨Auth Serviceï¼ˆ2å®ä¾‹ï¼‰
docker-compose -f docker-compose.prod.yml up -d \
  stock-auth-service-1 stock-auth-service-2

# 5. å¯åŠ¨Data Serviceï¼ˆ2å®ä¾‹ï¼‰
docker-compose -f docker-compose.prod.yml up -d \
  stock-data-service-1 stock-data-service-2

# 6. å¯åŠ¨Investment Serviceï¼ˆ2å®ä¾‹ï¼‰
docker-compose -f docker-compose.prod.yml up -d \
  stock-investment-service-1 stock-investment-service-2

# 7. å¯åŠ¨Correlation Serviceï¼ˆ2å®ä¾‹ï¼‰
docker-compose -f docker-compose.prod.yml up -d \
  stock-correlation-service-1 stock-correlation-service-2

# 8. ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 120
```

### æ­¥éª¤8: å¯åŠ¨Nginx

```bash
# 1. åˆ›å»ºè®¤è¯æ–‡ä»¶ï¼ˆç”¨äºç›‘æ§é¢æ¿ï¼‰
sudo apt install apache2-utils
htpasswd -c config/.htpasswd admin

# 2. å¯åŠ¨Nginx
docker-compose -f docker-compose.prod.yml up -d nginx
```

### æ­¥éª¤9: éªŒè¯éƒ¨ç½²

```bash
# 1. æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# 2. æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost/api/actuator/health

# 3. æ£€æŸ¥NacosæœåŠ¡æ³¨å†Œ
curl http://localhost:8848/nacos/v1/ns/instance/list?serviceName=stock-gateway

# 4. æ£€æŸ¥ç›‘æ§
curl http://localhost:9090/-/healthy  # Prometheus
curl http://localhost:3000/api/health # Grafana

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f --tail=100
```

---

## ğŸ”§ é…ç½®ä¼˜åŒ–

### 1. ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

```bash
# /etc/sysctl.conf
cat >> /etc/sysctl.conf <<EOF
# ç½‘ç»œä¼˜åŒ–
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.ip_local_port_range = 1024 65535

# æ–‡ä»¶æè¿°ç¬¦
fs.file-max = 1000000
fs.nr_open = 1000000

# å†…å­˜
vm.swappiness = 10
vm.max_map_count = 262144
EOF

# åº”ç”¨é…ç½®
sysctl -p
```

### 2. Dockerä¼˜åŒ–

```bash
# /etc/docker/daemon.json
cat > /etc/docker/daemon.json <<EOF
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "registry-mirrors": ["https://mirror.ccs.tencentyun.com"]
}
EOF

# é‡å¯Docker
systemctl restart docker
```

### 3. é…ç½®å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹ä»»åŠ¡
# MySQLå…¨é‡å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
0 2 * * * /opt/stock/scripts/backup-mysql.sh >> /var/log/stock/backup.log 2>&1

# æ¸…ç†Dockeræ—¥å¿—ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹ï¼‰
0 3 * * 0 find /var/lib/docker/containers -name "*.log" -mtime +7 -delete

# æ¸…ç†åº”ç”¨æ—¥å¿—ï¼ˆæ¯å¤©å‡Œæ™¨4ç‚¹ï¼‰
0 4 * * * find /var/log/stock -name "*.log" -mtime +30 -delete

# ç›‘æ§ç£ç›˜ç©ºé—´ï¼ˆæ¯å°æ—¶ï¼‰
0 * * * * df -h | grep -E '9[0-9]%' && echo "ç£ç›˜ç©ºé—´ä¸è¶³" | mail -s "å‘Šè­¦" ops@company.com
```

---

## ğŸ“Š ç›‘æ§é…ç½®

### 1. è®¿é—®ç›‘æ§é¢æ¿

- **Grafana**: https://your-domain.com/grafana/
  - ç”¨æˆ·å: admin
  - å¯†ç : åœ¨.envä¸­é…ç½®çš„GRAFANA_PASSWORD

- **Prometheus**: https://your-domain.com/prometheus/
  - éœ€è¦HTTP Basicè®¤è¯

- **Kibana**: http://your-domain.com:5601
  - é¦–æ¬¡è®¿é—®éœ€è¦é…ç½®ç´¢å¼•æ¨¡å¼: `stock-logs-*`

- **Nacos**: http://your-domain.com:8848/nacos
  - ç”¨æˆ·å: nacos
  - å¯†ç : nacos

- **RabbitMQ**: http://your-domain.com:15672
  - ç”¨æˆ·å: åœ¨.envä¸­é…ç½®çš„RABBITMQ_USER
  - å¯†ç : åœ¨.envä¸­é…ç½®çš„RABBITMQ_PASSWORD

### 2. é…ç½®å‘Šè­¦é€šçŸ¥

ç¼–è¾‘ `config/alertmanager.yml`ï¼Œé…ç½®é’‰é’‰æˆ–é‚®ä»¶é€šçŸ¥ï¼š

```yaml
receivers:
  - name: 'dingding'
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN'
```

---

## ğŸ”„ æ»šåŠ¨æ›´æ–°

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. æ„å»ºæ–°é•œåƒ
docker-compose -f docker-compose.prod.yml build stock-gateway

# 3. æ»šåŠ¨æ›´æ–°ï¼ˆé€ä¸ªé‡å¯ï¼‰
docker-compose -f docker-compose.prod.yml up -d --no-deps stock-gateway-1
sleep 30  # ç­‰å¾…æœåŠ¡å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --no-deps stock-gateway-2
sleep 30
docker-compose -f docker-compose.prod.yml up -d --no-deps stock-gateway-3

# 4. éªŒè¯æ›´æ–°
curl http://localhost/api/actuator/health
```

---

## ğŸ›¡ï¸ å®‰å…¨åŠ å›º

### 1. é˜²ç«å¢™é…ç½®

```bash
# å®‰è£…UFW
sudo apt install ufw

# å…è®¸SSH
sudo ufw allow 22/tcp

# å…è®¸HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å…è®¸ç›‘æ§ç«¯å£ï¼ˆä»…å†…ç½‘ï¼‰
sudo ufw allow from 10.0.0.0/8 to any port 9090
sudo ufw allow from 10.0.0.0/8 to any port 3000

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### 2. å®šæœŸå®‰å…¨æ›´æ–°

```bash
# è‡ªåŠ¨å®‰å…¨æ›´æ–°
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] æ‰€æœ‰å®¹å™¨æ­£å¸¸è¿è¡Œ
- [ ] æ‰€æœ‰æœåŠ¡æ³¨å†Œåˆ°Nacos
- [ ] æ•°æ®åº“ä¸»ä»å¤åˆ¶æ­£å¸¸
- [ ] Redis Sentinelæ­£å¸¸å·¥ä½œ
- [ ] RabbitMQé›†ç¾¤æ­£å¸¸
- [ ] ç›‘æ§é¢æ¿å¯ä»¥è®¿é—®
- [ ] å‘Šè­¦é€šçŸ¥æ­£å¸¸å·¥ä½œ
- [ ] SSLè¯ä¹¦é…ç½®æ­£ç¡®
- [ ] å¤‡ä»½ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
- [ ] æ—¥å¿—æ­£å¸¸æ”¶é›†
- [ ] APIæ¥å£æ­£å¸¸å“åº”
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸è®¿é—®

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æ•…éšœå¤„ç†æ‰‹å†Œ: [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)
- ä¼ä¸šçº§æ”¹é€ æ–‡æ¡£: [ä¼ä¸šçº§å‡çº§æŒ‡å—](./ä¼ä¸šçº§å‡çº§æŒ‡å—.md)
- æ—¥å¿—æ–‡ä»¶: `/var/log/stock/`

**è”ç³»æ–¹å¼**:
- æŠ€æœ¯æ”¯æŒ: support@company.com
- ç´§æ€¥çƒ­çº¿: 400-xxx-xxxx
