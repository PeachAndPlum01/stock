# 企业级改造文件清单

本文档列出了企业级改造过程中创建和修改的所有文件。

## 📁 新增文件

### 配置文件 (config/)
```
config/
├── alert-rules.yml              # Prometheus告警规则
├── alertmanager.yml             # AlertManager告警管理配置
├── grafana-datasources.yml      # Grafana数据源配置
├── logstash.conf                # Logstash日志处理配置
├── nginx.conf                   # Nginx负载均衡和HTTPS配置
└── prometheus.yml               # Prometheus监控配置
```

### 运维脚本 (scripts/)
```
scripts/
├── backup-mysql.sh              # MySQL全量备份脚本
├── deploy.sh                    # 一键部署脚本
├── init-db-users.sh             # 数据库用户初始化脚本
├── mysql-master.cnf             # MySQL主库配置
├── mysql-slave.cnf              # MySQL从库配置
├── rabbitmq-join-cluster.sh     # RabbitMQ集群加入脚本
├── redis-sentinel.conf          # Redis Sentinel配置
└── restore-mysql.sh             # MySQL恢复脚本
```

### 文档 (docs/)
```
docs/
├── DEPLOYMENT.md                # 生产环境部署文档
├── ENTERPRISE-UPGRADE.md        # 企业级改造文档
└── TROUBLESHOOTING.md           # 故障处理手册
```

### 根目录
```
├── docker-compose.prod.yml      # 生产环境Docker Compose配置
├── ENTERPRISE-READY.md          # 企业级改造完成总结
└── FILES-CHECKLIST.md           # 本文件
```

## 📝 修改文件

### 环境配置
```
.env.template                    # 更新：添加安全配置和独立账号
```

### 文档
```
README.md                        # 更新：添加企业级特性说明
```

## 📊 文件统计

| 类型 | 数量 | 说明 |
|------|------|------|
| **配置文件** | 6 | 监控、日志、负载均衡配置 |
| **运维脚本** | 8 | 部署、备份、恢复脚本 |
| **文档** | 4 | 部署、改造、故障处理文档 |
| **Docker配置** | 1 | 生产环境编排配置 |
| **总计** | 19 | 新增文件 |

## 🎯 文件用途说明

### 1. 监控配置文件

#### prometheus.yml
- **用途**: Prometheus监控配置
- **内容**: 
  - 监控所有微服务（Gateway、Auth、Data、Investment、Correlation）
  - 监控中间件（MySQL、Redis、RabbitMQ、Nacos）
  - 15秒采集间隔
- **位置**: `config/prometheus.yml`

#### alert-rules.yml
- **用途**: Prometheus告警规则
- **内容**:
  - 服务健康告警（宕机、错误率、响应时间）
  - 性能告警（CPU、内存、GC）
  - 数据库告警（慢查询、连接数、主从延迟）
  - 中间件告警（Redis、RabbitMQ）
- **位置**: `config/alert-rules.yml`

#### alertmanager.yml
- **用途**: AlertManager告警管理
- **内容**:
  - 钉钉机器人通知
  - 邮件通知
  - 告警分级（critical、warning）
  - 告警抑制规则
- **位置**: `config/alertmanager.yml`

#### grafana-datasources.yml
- **用途**: Grafana数据源配置
- **内容**: Prometheus数据源自动配置
- **位置**: `config/grafana-datasources.yml`

#### logstash.conf
- **用途**: Logstash日志处理
- **内容**:
  - 日志文件读取
  - 日志格式解析
  - TraceId和SpanId提取
  - Elasticsearch输出
- **位置**: `config/logstash.conf`

#### nginx.conf
- **用途**: Nginx负载均衡和HTTPS
- **内容**:
  - Gateway负载均衡（3实例）
  - HTTPS/SSL配置
  - 安全头配置
  - API限流（100次/分钟）
  - 静态资源缓存
- **位置**: `config/nginx.conf`

### 2. 运维脚本

#### deploy.sh
- **用途**: 一键部署脚本
- **功能**:
  - 环境检查（Docker、Docker Compose）
  - 配置验证
  - 自动生成SSL证书
  - 选择部署模式（开发/生产）
  - 健康检查
- **使用**: `./scripts/deploy.sh`

#### backup-mysql.sh
- **用途**: MySQL全量备份
- **功能**:
  - 全库备份
  - Gzip压缩
  - 自动清理30天前备份
- **使用**: `./scripts/backup-mysql.sh`
- **定时**: 每天凌晨2点（crontab）

#### restore-mysql.sh
- **用途**: MySQL数据恢复
- **功能**:
  - 从备份文件恢复
  - 自动停止业务服务
  - 恢复后重启服务
- **使用**: `./scripts/restore-mysql.sh /backup/mysql/full_backup_xxx.sql.gz`

#### init-db-users.sh
- **用途**: 初始化数据库用户
- **功能**:
  - 创建独立服务账号
  - 最小权限授权
  - 创建Zipkin数据库
- **使用**: `./scripts/init-db-users.sh`

#### mysql-master.cnf
- **用途**: MySQL主库配置
- **内容**:
  - 开启binlog
  - GTID模式
  - 性能优化参数
- **位置**: `scripts/mysql-master.cnf`

#### mysql-slave.cnf
- **用途**: MySQL从库配置
- **内容**:
  - 中继日志
  - 只读模式
  - GTID模式
- **位置**: `scripts/mysql-slave.cnf`

#### redis-sentinel.conf
- **用途**: Redis Sentinel配置
- **内容**:
  - 监控主节点
  - 故障转移配置
  - 认证配置
- **位置**: `scripts/redis-sentinel.conf`

#### rabbitmq-join-cluster.sh
- **用途**: RabbitMQ节点加入集群
- **功能**:
  - 自动加入集群
  - 配置镜像队列
- **位置**: `scripts/rabbitmq-join-cluster.sh`

### 3. 文档

#### ENTERPRISE-UPGRADE.md
- **用途**: 企业级改造详细文档
- **内容**:
  - 安全加固方案
  - 高可用架构设计
  - 监控告警体系
  - 数据备份与恢复
  - 性能优化
  - 运维管理
  - 安全检查清单
- **位置**: `docs/ENTERPRISE-UPGRADE.md`

#### DEPLOYMENT.md
- **用途**: 生产环境部署文档
- **内容**:
  - 服务器要求
  - 部署步骤
  - 配置优化
  - 监控配置
  - 滚动更新
  - 安全加固
  - 部署检查清单
- **位置**: `docs/DEPLOYMENT.md`

#### TROUBLESHOOTING.md
- **用途**: 故障处理手册
- **内容**:
  - 服务故障排查
  - 数据库故障处理
  - 缓存故障处理
  - 消息队列故障
  - 网络故障
  - 性能问题
  - 常见错误
- **位置**: `docs/TROUBLESHOOTING.md`

#### ENTERPRISE-READY.md
- **用途**: 企业级改造完成总结
- **内容**:
  - 改造项目清单
  - 改造成果对比
  - 快速开始指南
  - 注意事项
- **位置**: `ENTERPRISE-READY.md`

### 4. Docker配置

#### docker-compose.prod.yml
- **用途**: 生产环境Docker Compose配置
- **内容**:
  - MySQL主从架构（1主2从）
  - Redis Sentinel（1主2从+3哨兵）
  - RabbitMQ集群（3节点）
  - 服务多实例（Gateway×3, 业务服务×2）
  - 监控组件（Prometheus、Grafana、ELK、Zipkin）
  - Nginx负载均衡
  - 资源限制配置
  - 健康检查配置
- **位置**: `docker-compose.prod.yml`

## 🔍 快速查找

### 需要配置SSL证书
→ 查看 `config/nginx.conf` 和 `docs/DEPLOYMENT.md`

### 需要配置告警通知
→ 查看 `config/alertmanager.yml`

### 需要备份数据库
→ 使用 `scripts/backup-mysql.sh`

### 需要恢复数据库
→ 使用 `scripts/restore-mysql.sh`

### 需要部署生产环境
→ 查看 `docs/DEPLOYMENT.md` 或使用 `scripts/deploy.sh`

### 遇到故障问题
→ 查看 `docs/TROUBLESHOOTING.md`

### 了解企业级特性
→ 查看 `docs/ENTERPRISE-UPGRADE.md`

## ✅ 验证清单

部署后请验证以下文件是否正常工作：

### 配置文件验证
- [ ] Prometheus能正常采集指标
- [ ] Grafana能正常显示监控面板
- [ ] AlertManager能正常发送告警
- [ ] Nginx能正常负载均衡
- [ ] Logstash能正常收集日志

### 脚本验证
- [ ] deploy.sh能正常部署
- [ ] backup-mysql.sh能正常备份
- [ ] restore-mysql.sh能正常恢复
- [ ] init-db-users.sh能正常创建用户

### 文档验证
- [ ] 按照DEPLOYMENT.md能成功部署
- [ ] 按照TROUBLESHOOTING.md能解决问题
- [ ] ENTERPRISE-UPGRADE.md内容准确

## 📞 支持

如有问题，请参考：
- 部署问题: `docs/DEPLOYMENT.md`
- 故障问题: `docs/TROUBLESHOOTING.md`
- 企业级特性: `docs/ENTERPRISE-UPGRADE.md`

---

**文档版本**: 1.0  
**创建日期**: 2026-02-06  
**维护团队**: 运维团队
