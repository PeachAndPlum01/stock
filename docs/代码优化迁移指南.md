# ä»£ç ä¼˜åŒ–è¿ç§»æŒ‡å—

## ğŸ“‹ ç›®æ ‡
å°†å·²å®Œæˆçš„ä¼˜åŒ–åº”ç”¨åˆ°å…¶ä»–å¾®æœåŠ¡

---

## ğŸ¯ éœ€è¦è¿ç§»çš„æœåŠ¡

- [ ] stock-investment-service
- [ ] stock-market-service  
- [ ] stock-realtime-service
- [ ] stock-gatewayï¼ˆéƒ¨åˆ†ä¼˜åŒ–ï¼‰

---

## ğŸ“¦ æ­¥éª¤1: æ·»åŠ ä¾èµ–

### 1.1 ç¡®ä¿æ‰€æœ‰æœåŠ¡çš„pom.xmléƒ½å¼•å…¥äº†stock-commonæ¨¡å—

```xml
<!-- å…¬å…±æ¨¡å— -->
<dependency>
    <groupId>com.stock</groupId>
    <artifactId>stock-common</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 1.2 éœ€è¦ä½¿ç”¨Redissonçš„æœåŠ¡æ·»åŠ ä¾èµ–

```xml
<!-- Redisson -->
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
</dependency>
```

**éœ€è¦æ·»åŠ çš„æœåŠ¡**:
- stock-investment-service
- stock-market-service

---

## ğŸ”§ æ­¥éª¤2: ä¼˜åŒ–Controllerå±‚

### 2.1 ä¿®æ”¹è¿”å›å€¼ç±»å‹

**ä¿®æ”¹å‰**:
```java
@PostMapping("/api")
public ResponseEntity<Map<String, Object>> api(@RequestBody Map<String, String> request) {
    try {
        // ä¸šåŠ¡é€»è¾‘
        Map<String, Object> response = new HashMap<>();
        response.put("code", 200);
        response.put("message", "æˆåŠŸ");
        response.put("data", data);
        return ResponseEntity.ok(response);
    } catch (Exception e) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 400);
        response.put("message", e.getMessage());
        return ResponseEntity.badRequest().body(response);
    }
}
```

**ä¿®æ”¹å**:
```java
@PostMapping("/api")
@OperationLog(module = "æ¨¡å—å", operation = "æ“ä½œå")
public Result<DataType> api(@Valid @RequestBody RequestDTO request) {
    // ä¸šåŠ¡é€»è¾‘ï¼ˆå¼‚å¸¸ä¼šè¢«å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·ï¼‰
    DataType data = service.doSomething(request);
    return Result.success(data);
}
```

### 2.2 åˆ›å»ºè¯·æ±‚DTO

åœ¨`stock-common/src/main/java/com/stock/common/dto/`ç›®å½•ä¸‹åˆ›å»ºDTOï¼š

```java
@Data
public class XxxRequest implements Serializable {
    
    @NotBlank(message = "å­—æ®µä¸èƒ½ä¸ºç©º")
    @Size(min = 1, max = 50, message = "é•¿åº¦å¿…é¡»åœ¨1-50ä¹‹é—´")
    private String field1;
    
    @NotNull(message = "å­—æ®µä¸èƒ½ä¸ºç©º")
    @Min(value = 1, message = "å¿…é¡»å¤§äº0")
    private Integer field2;
}
```

### 2.3 æ·»åŠ æ³¨è§£

- `@OperationLog` - è®°å½•æ“ä½œæ—¥å¿—
- `@Idempotent` - ä¿è¯å¹‚ç­‰æ€§ï¼ˆç”¨äºåˆ›å»ºã€æäº¤ç­‰æ“ä½œï¼‰
- `@RateLimit` - é™æµï¼ˆç”¨äºé«˜é¢‘æ¥å£ï¼‰

---

## ğŸ”§ æ­¥éª¤3: ä¼˜åŒ–Serviceå±‚

### 3.1 ä½¿ç”¨BusinessException

**ä¿®æ”¹å‰**:
```java
if (user == null) {
    throw new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨");
}
```

**ä¿®æ”¹å**:
```java
if (user == null) {
    throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
}
```

### 3.2 ä¼˜åŒ–ç¼“å­˜ä½¿ç”¨

**éœ€è¦ä¼˜åŒ–çš„æœåŠ¡**: stock-investment-service, stock-market-service

**æ·»åŠ å¸ƒéš†è¿‡æ»¤å™¨**:
```java
@Service
public class XxxService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    private RBloomFilter<String> bloomFilter;
    
    @PostConstruct
    public void initBloomFilter() {
        bloomFilter = redissonClient.getBloomFilter("xxx:filter");
        if (!bloomFilter.isExists()) {
            bloomFilter.tryInit(10000, 0.01);
        }
        // åŠ è½½æ•°æ®åˆ°å¸ƒéš†è¿‡æ»¤å™¨
    }
    
    public Data getData(String key) {
        // 1. æ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨
        if (!bloomFilter.contains(key)) {
            return null;
        }
        
        // 2. æŸ¥è¯¢ç¼“å­˜
        String cacheKey = "cache:" + key;
        Object cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return (Data) cached;
        }
        
        // 3. ä½¿ç”¨åˆ†å¸ƒå¼é”
        RLock lock = redissonClient.getLock("lock:" + key);
        try {
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                // åŒé‡æ£€æŸ¥
                cached = redisTemplate.opsForValue().get(cacheKey);
                if (cached != null) {
                    return (Data) cached;
                }
                
                // æŸ¥è¯¢æ•°æ®åº“
                Data data = queryFromDB(key);
                if (data != null) {
                    // éšæœºè¿‡æœŸæ—¶é—´
                    long expireTime = 3600 + (long) (Math.random() * 600);
                    redisTemplate.opsForValue().set(cacheKey, data, expireTime, TimeUnit.SECONDS);
                }
                return data;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
        
        return null;
    }
}
```

### 3.3 ä¼˜åŒ–å®šæ—¶ä»»åŠ¡

**ä¿®æ”¹å‰**:
```java
@Scheduled(fixedRate = 10000)
public void scheduledTask() {
    // ä»»åŠ¡é€»è¾‘
}
```

**ä¿®æ”¹å**:
```java
@Scheduled(fixedRate = 10000)
public void scheduledTask() {
    RLock lock = redissonClient.getLock("lock:scheduled:taskName");
    
    try {
        if (!lock.tryLock(0, 10, TimeUnit.SECONDS)) {
            log.debug("å…¶ä»–èŠ‚ç‚¹æ­£åœ¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œè·³è¿‡");
            return;
        }
        
        doScheduledTask();
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}

private void doScheduledTask() {
    // ä»»åŠ¡é€»è¾‘
}
```

---

## ğŸ”§ æ­¥éª¤4: ä¼˜åŒ–é…ç½®æ–‡ä»¶

### 4.1 ä¼˜åŒ–application.yml

åœ¨æ¯ä¸ªæœåŠ¡çš„`application.yml`ä¸­æ·»åŠ ï¼š

```yaml
spring:
  datasource:
    # HikariCPè¿æ¥æ± é…ç½®
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
      pool-name: StockXxxHikariPool
      auto-commit: true
      leak-detection-threshold: 60000

# æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.stock: INFO
    org.springframework: WARN
    com.baomidou.mybatisplus: WARN
```

### 4.2 åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

åˆ›å»º`application-prod.yml`:

```yaml
# æ—¥å¿—é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
logging:
  level:
    root: WARN
    com.stock: INFO
    org.springframework: ERROR
    com.baomidou.mybatisplus: WARN

# å…³é—­Swaggerï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false
```

---

## ğŸ“‹ æ­¥éª¤5: æœåŠ¡è¿ç§»æ¸…å•

### stock-investment-service

#### Controllerå±‚
- [ ] InvestmentInfoController
  - [ ] ä¿®æ”¹è¿”å›å€¼ä¸ºResult<T>
  - [ ] åˆ›å»ºè¯·æ±‚DTOå¹¶æ·»åŠ æ ¡éªŒ
  - [ ] æ·»åŠ @OperationLogæ³¨è§£
  - [ ] ç§»é™¤try-catchï¼ˆç”±å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†ï¼‰

#### Serviceå±‚
- [ ] InvestmentInfoService
  - [ ] RuntimeException â†’ BusinessException
  - [ ] æ·»åŠ ç¼“å­˜é˜²æŠ¤ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨+åˆ†å¸ƒå¼é”ï¼‰
  - [ ] å®šæ—¶ä»»åŠ¡æ·»åŠ åˆ†å¸ƒå¼é”

#### é…ç½®
- [ ] pom.xmlæ·»åŠ Redissonä¾èµ–
- [ ] application.ymlä¼˜åŒ–è¿æ¥æ± å’Œæ—¥å¿—
- [ ] åˆ›å»ºapplication-prod.yml

---

### stock-market-service

#### Controllerå±‚
- [ ] MarketController
  - [ ] ä¿®æ”¹è¿”å›å€¼ä¸ºResult<T>
  - [ ] åˆ›å»ºè¯·æ±‚DTOå¹¶æ·»åŠ æ ¡éªŒ
  - [ ] æ·»åŠ @OperationLogæ³¨è§£
  - [ ] ç§»é™¤try-catch

#### Serviceå±‚
- [ ] MarketService
  - [ ] RuntimeException â†’ BusinessException
  - [ ] æ·»åŠ ç¼“å­˜é˜²æŠ¤
  - [ ] å®šæ—¶ä»»åŠ¡æ·»åŠ åˆ†å¸ƒå¼é”

#### é…ç½®
- [ ] pom.xmlæ·»åŠ Redissonä¾èµ–
- [ ] application.ymlä¼˜åŒ–
- [ ] åˆ›å»ºapplication-prod.yml

---

### stock-realtime-service

#### Controllerå±‚
- [ ] RealtimeController
  - [ ] ä¿®æ”¹è¿”å›å€¼ä¸ºResult<T>
  - [ ] æ·»åŠ @OperationLogæ³¨è§£
  - [ ] æ·»åŠ @RateLimité™æµï¼ˆé«˜é¢‘æ¥å£ï¼‰

#### Serviceå±‚
- [ ] RealtimeService
  - [ ] RuntimeException â†’ BusinessException
  - [ ] ä¼˜åŒ–WebSocketè¿æ¥ç®¡ç†

#### é…ç½®
- [ ] application.ymlä¼˜åŒ–
- [ ] åˆ›å»ºapplication-prod.yml

---

## ğŸ§ª æ­¥éª¤6: æµ‹è¯•éªŒè¯

### 6.1 åŠŸèƒ½æµ‹è¯•
- [ ] æµ‹è¯•æ‰€æœ‰APIæ¥å£æ˜¯å¦æ­£å¸¸
- [ ] æµ‹è¯•å‚æ•°æ ¡éªŒæ˜¯å¦ç”Ÿæ•ˆ
- [ ] æµ‹è¯•å¼‚å¸¸å¤„ç†æ˜¯å¦æ­£ç¡®

### 6.2 æ€§èƒ½æµ‹è¯•
- [ ] æµ‹è¯•ç¼“å­˜å‘½ä¸­ç‡
- [ ] æµ‹è¯•å¹¶å‘æ€§èƒ½
- [ ] æµ‹è¯•å®šæ—¶ä»»åŠ¡æ˜¯å¦åªæ‰§è¡Œä¸€æ¬¡

### 6.3 æ—¥å¿—æ£€æŸ¥
- [ ] æ£€æŸ¥æ“ä½œæ—¥å¿—æ˜¯å¦è®°å½•
- [ ] æ£€æŸ¥å¼‚å¸¸æ—¥å¿—æ˜¯å¦å®Œæ•´
- [ ] æ£€æŸ¥æ—¥å¿—çº§åˆ«æ˜¯å¦åˆç†

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. å…¼å®¹æ€§
- ç¡®ä¿æ‰€æœ‰æœåŠ¡éƒ½å‡çº§åˆ°ç›¸åŒç‰ˆæœ¬çš„stock-common
- å‰ç«¯éœ€è¦é€‚é…æ–°çš„å“åº”æ ¼å¼ï¼ˆå¦‚æœä¹‹å‰ä¸æ˜¯Resultæ ¼å¼ï¼‰

### 2. æ•°æ®è¿ç§»
- å¦‚æœä¹‹å‰ä½¿ç”¨MD5åŠ å¯†çš„å¯†ç ï¼Œéœ€è¦æç¤ºç”¨æˆ·é‡ç½®å¯†ç 
- æˆ–è€…åœ¨ç™»å½•æ—¶æ£€æµ‹MD5å¯†ç ï¼Œè‡ªåŠ¨å‡çº§ä¸ºBCrypt

### 3. ç›‘æ§å‘Šè­¦
- æ·»åŠ Redisè¿æ¥ç›‘æ§
- æ·»åŠ åˆ†å¸ƒå¼é”è¶…æ—¶å‘Šè­¦
- æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

### 4. æ–‡æ¡£æ›´æ–°
- æ›´æ–°APIæ–‡æ¡£ï¼ˆå“åº”æ ¼å¼å˜åŒ–ï¼‰
- æ›´æ–°éƒ¨ç½²æ–‡æ¡£ï¼ˆæ–°å¢Redissoné…ç½®ï¼‰
- æ›´æ–°å¼€å‘è§„èŒƒæ–‡æ¡£

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ€å°åŒ–è¿ç§»ï¼ˆ1å°æ—¶ï¼‰
åªè¿ç§»æœ€å…³é”®çš„ä¼˜åŒ–ï¼š
1. âœ… å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆå·²å®Œæˆï¼Œè‡ªåŠ¨ç”Ÿæ•ˆï¼‰
2. âœ… ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆä¿®æ”¹Controllerè¿”å›å€¼ï¼‰
3. âœ… å‚æ•°æ ¡éªŒï¼ˆåˆ›å»ºDTOï¼‰

### æ ‡å‡†è¿ç§»ï¼ˆ4å°æ—¶ï¼‰
åŒ…å«æ‰€æœ‰é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼š
1. âœ… æœ€å°åŒ–è¿ç§»çš„æ‰€æœ‰å†…å®¹
2. âœ… æ“ä½œæ—¥å¿—è®°å½•
3. âœ… æ¥å£å¹‚ç­‰æ€§
4. âœ… é…ç½®ä¼˜åŒ–

### å®Œæ•´è¿ç§»ï¼ˆ8å°æ—¶ï¼‰
åŒ…å«æ‰€æœ‰ä¼˜åŒ–ï¼š
1. âœ… æ ‡å‡†è¿ç§»çš„æ‰€æœ‰å†…å®¹
2. âœ… ç¼“å­˜é˜²æŠ¤ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨+åˆ†å¸ƒå¼é”ï¼‰
3. âœ… å®šæ—¶ä»»åŠ¡åˆ†å¸ƒå¼é”
4. âœ… æ¥å£é™æµ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [ä»£ç ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š](./CODE-OPTIMIZATION-REPORT.md)
- [æŠ€æœ¯ç»„ä»¶é›†æˆæ–‡æ¡£](./TECHNICAL-COMPONENTS.md)
- [ä¼ä¸šçº§å‡çº§æŒ‡å—](./ENTERPRISE-UPGRADE.md)

---

## âœ… è¿ç§»å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æœåŠ¡éƒ½å¼•å…¥äº†stock-commonæ¨¡å—
- [ ] æ‰€æœ‰Controlleréƒ½ä½¿ç”¨Result<T>è¿”å›å€¼
- [ ] æ‰€æœ‰è¯·æ±‚å‚æ•°éƒ½åˆ›å»ºäº†DTOå¹¶æ·»åŠ æ ¡éªŒ
- [ ] æ‰€æœ‰RuntimeExceptionéƒ½æ”¹ä¸ºBusinessException
- [ ] å…³é”®æ¥å£éƒ½æ·»åŠ äº†@OperationLog
- [ ] åˆ›å»º/æäº¤æ¥å£éƒ½æ·»åŠ äº†@Idempotent
- [ ] é«˜é¢‘æ¥å£éƒ½æ·»åŠ äº†@RateLimit
- [ ] ç¼“å­˜æŸ¥è¯¢éƒ½æ·»åŠ äº†é˜²æŠ¤ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨+åˆ†å¸ƒå¼é”ï¼‰
- [ ] å®šæ—¶ä»»åŠ¡éƒ½æ·»åŠ äº†åˆ†å¸ƒå¼é”
- [ ] é…ç½®æ–‡ä»¶éƒ½ä¼˜åŒ–äº†è¿æ¥æ± å’Œæ—¥å¿—
- [ ] åˆ›å»ºäº†ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
- [ ] æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡æµ‹è¯•éªŒè¯

---

**é¢„è®¡æ€»å·¥ä½œé‡**: 
- stock-investment-service: 3å°æ—¶
- stock-market-service: 3å°æ—¶
- stock-realtime-service: 2å°æ—¶
- **æ€»è®¡**: 8å°æ—¶

**å»ºè®®åˆ†æ‰¹è¿ç§»ï¼Œæ¯å®Œæˆä¸€ä¸ªæœåŠ¡å°±è¿›è¡Œæµ‹è¯•éªŒè¯ï¼** âœ…
