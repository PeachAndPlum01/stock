# è‚¡ç¥¨ç³»ç»ŸæŠ€æœ¯ç»„ä»¶é›†æˆæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†è‚¡ç¥¨ç³»ç»Ÿæ–°å¢çš„æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶åŠå…¶ä½¿ç”¨æ–¹æ³•ã€‚

---

## ğŸš€ æ–°å¢æŠ€æœ¯ç»„ä»¶

### 1. WebSocketå®æ—¶æ¨é€

**åŠŸèƒ½**: å®ç°è‚¡ç¥¨è¡Œæƒ…çš„å®æ—¶æ¨é€

**æŠ€æœ¯æ ˆ**: 
- Spring WebSocket
- STOMPåè®®
- SockJS

**ä½¿ç”¨æ–¹å¼**:

#### åç«¯æ¨é€
```java
@Autowired
private RealtimeQuoteService quoteService;

// æ¨é€å•ä¸ªè¡Œæƒ…
RealtimeQuote quote = ...;
quoteService.pushQuote(quote);

// æ‰¹é‡æ¨é€
List<RealtimeQuote> quotes = ...;
quoteService.pushQuoteBatch(quotes);
```

#### å‰ç«¯è®¢é˜…
```javascript
// è¿æ¥WebSocket
const socket = new SockJS('http://localhost:8085/ws/stock');
const stompClient = Stomp.over(socket);

stompClient.connect({}, function(frame) {
    // è®¢é˜…è‚¡ç¥¨è¡Œæƒ…
    stompClient.subscribe('/topic/quote/000001', function(message) {
        const quote = JSON.parse(message.body);
        console.log('æ”¶åˆ°è¡Œæƒ…:', quote);
    });
});
```

**è®¿é—®åœ°å€**: 
- WebSocketç«¯ç‚¹: `ws://localhost:8085/ws/stock`
- REST API: `http://localhost:8085/api/realtime/quote/{stockCode}`

---

### 2. XXL-JOBåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

**åŠŸèƒ½**: ç®¡ç†å®šæ—¶ä»»åŠ¡ï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œç›‘æ§

**ç‰¹æ€§**:
- åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦
- ä»»åŠ¡å¤±è´¥é‡è¯•
- ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- åŠ¨æ€é…ç½®ä»»åŠ¡

**é…ç½®**:
```yaml
xxl:
  job:
    admin:
      addresses: http://localhost:8080/xxl-job-admin
    executor:
      appname: stock-realtime-executor
      port: 9999
```

**ä½¿ç”¨ç¤ºä¾‹**:
```java
@XxlJob("pushQuoteJob")
public void pushQuoteJob() {
    log.info("å¼€å§‹æ¨é€å®æ—¶è¡Œæƒ…...");
    // ä»»åŠ¡é€»è¾‘
}
```

**å·²é…ç½®ä»»åŠ¡**:
1. `pushQuoteJob` - æ¨é€å®æ—¶è¡Œæƒ…
2. `cleanCacheJob` - æ¸…ç†è¿‡æœŸç¼“å­˜
3. `syncHistoryDataJob` - åŒæ­¥å†å²æ•°æ®åˆ°InfluxDB

**è®¿é—®åœ°å€**: `http://localhost:8080/xxl-job-admin`
- é»˜è®¤è´¦å·: admin / 123456

---

### 3. InfluxDBæ—¶åºæ•°æ®åº“

**åŠŸèƒ½**: é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢Kçº¿æ•°æ®ã€æŠ€æœ¯æŒ‡æ ‡ç­‰æ—¶åºæ•°æ®

**ç‰¹æ€§**:
- é«˜æ€§èƒ½æ—¶åºæ•°æ®å­˜å‚¨
- å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€(Flux)
- æ•°æ®å‹ç¼©å’Œä¿ç•™ç­–ç•¥
- å®æ—¶æ•°æ®èšåˆ

**é…ç½®**:
```yaml
influxdb:
  url: http://localhost:8086
  token: my-super-secret-auth-token
  org: stock-org
  bucket: stock-data
```

**ä½¿ç”¨ç¤ºä¾‹**:
```java
@Autowired
private InfluxDBClient influxDBClient;

// å†™å…¥æ•°æ®
Point point = Point.measurement("stock_price")
    .addTag("stock_code", "000001")
    .addField("price", 100.50)
    .time(Instant.now(), WritePrecision.NS);
    
writeApi.writePoint(point);

// æŸ¥è¯¢æ•°æ®
String flux = "from(bucket:\"stock-data\") "
    + "|> range(start: -1h) "
    + "|> filter(fn: (r) => r._measurement == \"stock_price\")";
    
List<FluxTable> tables = queryApi.query(flux);
```

**è®¿é—®åœ°å€**: `http://localhost:8086`
- ç”¨æˆ·å: admin
- å¯†ç : admin123456

---

### 4. TA4JæŠ€æœ¯åˆ†æåº“

**åŠŸèƒ½**: è®¡ç®—å„ç§æŠ€æœ¯æŒ‡æ ‡

**æ”¯æŒæŒ‡æ ‡**:
- MA (ç§»åŠ¨å¹³å‡çº¿): MA5, MA10, MA20, MA30, MA60, MA120, MA250
- MACD (æŒ‡æ•°å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿)
- KDJ (éšæœºæŒ‡æ ‡)
- RSI (ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡)
- BOLL (å¸ƒæ—å¸¦)

**ä½¿ç”¨ç¤ºä¾‹**:
```java
@Autowired
private TechnicalIndicatorService indicatorService;

// è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
CompletableFuture<TechnicalIndicator> future = 
    indicatorService.calculateIndicators(stockCode, barSeries);
    
TechnicalIndicator indicator = future.get();
System.out.println("MA5: " + indicator.getMa().getMa5());
System.out.println("MACDä¿¡å·: " + indicator.getMacd().getSignal());
```

---

### 5. å¤šçº§ç¼“å­˜ä¼˜åŒ–

**æ¶æ„**: L1 (Caffeineæœ¬åœ°ç¼“å­˜) + L2 (Redisåˆ†å¸ƒå¼ç¼“å­˜)

**ç‰¹æ€§**:
- æœ¬åœ°ç¼“å­˜å¿«é€Ÿè®¿é—®
- Rediså…±äº«æ•°æ®
- è‡ªåŠ¨ç¼“å­˜é¢„çƒ­
- ç¼“å­˜ç»Ÿè®¡ç›‘æ§

**é…ç½®**:
```java
// è‚¡ç¥¨ä»·æ ¼ç¼“å­˜ - 5ç§’è¿‡æœŸ
@Bean
public Cache<String, Object> stockPriceCache() {
    return Caffeine.newBuilder()
        .maximumSize(5000)
        .expireAfterWrite(5, TimeUnit.SECONDS)
        .recordStats()
        .build();
}

// æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜ - 5åˆ†é’Ÿè¿‡æœŸ
@Bean
public Cache<String, Object> technicalIndicatorCache() {
    return Caffeine.newBuilder()
        .maximumSize(2000)
        .expireAfterWrite(300, TimeUnit.SECONDS)
        .recordStats()
        .build();
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```java
// è‡ªåŠ¨å¤šçº§ç¼“å­˜æŸ¥è¯¢
RealtimeQuote quote = quoteService.getQuote(stockCode);
// 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
// 2. å†æŸ¥Redis
// 3. æœ€åæŸ¥æ•°æ®åº“
```

---

### 6. Redissoné«˜çº§ç‰¹æ€§

**åŠŸèƒ½**: Redisçš„é«˜çº§åŠŸèƒ½å°è£…

**ç‰¹æ€§**:
- åˆ†å¸ƒå¼é”
- åˆ†å¸ƒå¼é›†åˆ
- å¸ƒéš†è¿‡æ»¤å™¨
- é™æµå™¨

**ä½¿ç”¨ç¤ºä¾‹**:
```java
@Autowired
private RedissonClient redissonClient;

// åˆ†å¸ƒå¼é”
RLock lock = redissonClient.getLock("stock:lock:" + stockCode);
try {
    lock.lock(10, TimeUnit.SECONDS);
    // ä¸šåŠ¡é€»è¾‘
} finally {
    lock.unlock();
}

// å¸ƒéš†è¿‡æ»¤å™¨
RBloomFilter<String> bloomFilter = redissonClient.getBloomFilter("stock:filter");
bloomFilter.tryInit(100000, 0.01);
bloomFilter.add(stockCode);
boolean exists = bloomFilter.contains(stockCode);
```

---

### 7. å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± 

**åŠŸèƒ½**: ä¼˜åŒ–å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ

**é…ç½®çš„çº¿ç¨‹æ± **:
1. **quotePushExecutor** - è¡Œæƒ…æ¨é€ (æ ¸å¿ƒ20, æœ€å¤§50)
2. **indicatorCalculateExecutor** - æŠ€æœ¯æŒ‡æ ‡è®¡ç®— (æ ¸å¿ƒ10, æœ€å¤§30)
3. **dataPersistExecutor** - æ•°æ®æŒä¹…åŒ– (æ ¸å¿ƒ5, æœ€å¤§15)

**ä½¿ç”¨ç¤ºä¾‹**:
```java
@Async("quotePushExecutor")
public void pushQuote(RealtimeQuote quote) {
    // å¼‚æ­¥æ¨é€è¡Œæƒ…
}

@Async("indicatorCalculateExecutor")
public CompletableFuture<TechnicalIndicator> calculateIndicators() {
    // å¼‚æ­¥è®¡ç®—æŒ‡æ ‡
}
```

---

## ğŸ“Š æœåŠ¡ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| stock-gateway | 8080 | APIç½‘å…³ |
| stock-auth-service | 8081 | è®¤è¯æœåŠ¡ |
| stock-data-service | 8082 | æ•°æ®æœåŠ¡ |
| stock-investment-service | 8083 | æŠ•èµ„æœåŠ¡ |
| stock-correlation-service | 8084 | å…³è”æœåŠ¡ |
| **stock-realtime-service** | **8085** | **å®æ—¶è¡Œæƒ…æœåŠ¡** |
| InfluxDB | 8086 | æ—¶åºæ•°æ®åº“ |
| Spring Boot Admin | 8090 | ç›‘æ§æœåŠ¡ |
| Zipkin | 9411 | é“¾è·¯è¿½è¸ª |
| XXL-JOB Executor | 9999 | ä»»åŠ¡æ‰§è¡Œå™¨ |

---

## ğŸ”§ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åŸºç¡€è®¾æ–½
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f stock-realtime-service
```

### 2. æµ‹è¯•å®æ—¶æ¨é€
```bash
# ç”Ÿæˆæ¨¡æ‹Ÿè¡Œæƒ…
curl -X POST http://localhost:8085/api/realtime/quote/mock/000001?stockName=å¹³å®‰é“¶è¡Œ

# è·å–å®æ—¶è¡Œæƒ…
curl http://localhost:8085/api/realtime/quote/000001
```

### 3. å‰ç«¯WebSocketè¿æ¥
```html
<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <div id="quotes"></div>
    <script>
        const socket = new SockJS('http://localhost:8085/ws/stock');
        const stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            
            // è®¢é˜…å¤šåªè‚¡ç¥¨
            ['000001', '000002', '600000'].forEach(code => {
                stompClient.subscribe('/topic/quote/' + code, function(message) {
                    const quote = JSON.parse(message.body);
                    document.getElementById('quotes').innerHTML += 
                        `<p>${quote.stockCode}: ${quote.currentPrice} (${quote.changePercent}%)</p>`;
                });
            });
        });
    </script>
</body>
</html>
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜ç­–ç•¥
- çƒ­ç‚¹è‚¡ç¥¨ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œ5ç§’è¿‡æœŸ
- æŠ€æœ¯æŒ‡æ ‡ä½¿ç”¨5åˆ†é’Ÿç¼“å­˜
- å†å²æ•°æ®ä½¿ç”¨Redisç¼“å­˜ï¼Œ1å°æ—¶è¿‡æœŸ

### 2. æ¨é€ä¼˜åŒ–
- æ‰¹é‡æ¨é€å‡å°‘ç½‘ç»œå¼€é”€
- ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹æ± æé«˜å¹¶å‘
- WebSocketè¿æ¥æ± ç®¡ç†

### 3. æ•°æ®åº“ä¼˜åŒ–
- Kçº¿æ•°æ®å­˜å‚¨åˆ°InfluxDB
- MySQLåªå­˜å‚¨åŸºç¡€ä¿¡æ¯
- ä½¿ç”¨æ•°æ®å‹ç¼©å’Œä¿ç•™ç­–ç•¥

---

## ğŸ” ç›‘æ§ä¸å‘Šè­¦

### 1. ç¼“å­˜ç›‘æ§
```java
// æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
CacheStats stats = stockPriceCache.stats();
System.out.println("å‘½ä¸­ç‡: " + stats.hitRate());
System.out.println("åŠ è½½æ¬¡æ•°: " + stats.loadCount());
```

### 2. ä»»åŠ¡ç›‘æ§
- è®¿é—®XXL-JOBç®¡ç†ç•Œé¢æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
- æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿—å’Œå¤±è´¥é‡è¯•

### 3. é“¾è·¯è¿½è¸ª
- è®¿é—®ZipkinæŸ¥çœ‹æœåŠ¡è°ƒç”¨é“¾è·¯
- åˆ†ææ€§èƒ½ç“¶é¢ˆ

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. WebSocketè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8085/actuator/health

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -an | grep 8085

# æŸ¥çœ‹æ—¥å¿—
docker logs stock-realtime-service
```

### 2. InfluxDBè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥InfluxDBçŠ¶æ€
docker exec -it stock-influxdb influx ping

# æµ‹è¯•è¿æ¥
curl http://localhost:8086/health
```

### 3. ç¼“å­˜é—®é¢˜
```bash
# æ£€æŸ¥Redisè¿æ¥
docker exec -it stock-redis redis-cli ping

# æŸ¥çœ‹ç¼“å­˜é”®
docker exec -it stock-redis redis-cli keys "stock:*"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [WebSocketå®˜æ–¹æ–‡æ¡£](https://spring.io/guides/gs/messaging-stomp-websocket/)
- [XXL-JOBæ–‡æ¡£](https://www.xuxueli.com/xxl-job/)
- [InfluxDBæ–‡æ¡£](https://docs.influxdata.com/)
- [TA4Jæ–‡æ¡£](https://ta4j.github.io/ta4j-wiki/)
- [Caffeineæ–‡æ¡£](https://github.com/ben-manes/caffeine)
- [Redissonæ–‡æ¡£](https://github.com/redisson/redisson)

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… å®æ—¶æ¨é€æœåŠ¡
2. âœ… æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
3. âœ… å¤šçº§ç¼“å­˜ä¼˜åŒ–
4. â³ æ™ºèƒ½é€‰è‚¡æœåŠ¡
5. â³ é¢„è­¦é€šçŸ¥æœåŠ¡
6. â³ å›æµ‹ç³»ç»Ÿ
7. â³ é‡åŒ–äº¤æ˜“æœåŠ¡

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®æ—¶æ¨é€
- ä½¿ç”¨å¿ƒè·³æœºåˆ¶ä¿æŒè¿æ¥
- å®ç°æ–­çº¿é‡è¿
- é™åˆ¶æ¨é€é¢‘ç‡é¿å…è¿‡è½½

### 2. ç¼“å­˜ä½¿ç”¨
- åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- å®ç°ç¼“å­˜é¢„çƒ­

### 3. ä»»åŠ¡è°ƒåº¦
- é¿å…ä»»åŠ¡é‡å¤æ‰§è¡Œ
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- å®ç°å¤±è´¥é‡è¯•æœºåˆ¶

---

**æ›´æ–°æ—¶é—´**: 2026-02-06
**ç‰ˆæœ¬**: v2.0.0
