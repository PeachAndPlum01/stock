# 案例：前端登录报500错误 - 端口配置问题

## 📋 案例信息

| 项目 | 内容 |
|------|------|
| **案例编号** | CASE-2026-02-08-001 |
| **发生时间** | 2026-02-08 00:00 |
| **影响范围** | 前端登录功能 |
| **严重程度** | 🔴 高 - 用户无法登录系统 |
| **处理时长** | 约10分钟 |
| **负责人员** | 开发团队 |

---

## 🚨 问题描述

### 症状

- 前端用户尝试登录系统时，返回500错误
- 浏览器控制台显示网络请求失败
- 所有基于认证的功能均无法使用

### 环境信息

| 组件 | 预期端口 | 实际端口 | 状态 |
|------|---------|---------|------|
| 前端开发服务器 | 5173 | 5173 | ✅ 正常 |
| 前端API代理目标 | 8080 | 8888 | ❌ 错误 |
| 网关服务 | 8080 | 8080 | ✅ 正常 |
| 认证服务 | 8081 | 8081 | ✅ 正常 |

---

## 🔍 排查过程

### 第一步：检查前端错误

**操作**：在浏览器开发者工具中查看网络请求

**发现**：
- 登录请求：`POST http://localhost:5173/api/auth/login`
- 返回状态：500 Internal Server Error
- 响应体为空或通用错误信息

### 第二步：检查网关服务状态

**操作**：检查网关服务是否正常运行

```bash
# 检查端口占用
lsof -i :8080
# 输出：java进程正在监听8080端口 ✅

# 测试网关健康检查
curl http://localhost:8080/actuator/health
# 输出：{"status":"UP"} ✅
```

**结论**：网关服务正常运行

### 第三步：检查认证服务状态

**操作**：检查认证服务是否正常运行

```bash
# 检查端口占用
lsof -i :8081
# 输出：java进程正在监听8081端口 ✅

# 测试认证服务健康检查
curl http://localhost:8081/actuator/health
# 输出：{"status":"UP"} ✅

# 直接测试登录接口
curl -X POST http://localhost:8081/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
# 输出：返回正确的JWT token ✅
```

**结论**：认证服务功能正常

### 第四步：检查前端代理配置

**操作**：查看前端Vite配置文件

**文件**：`frontend/vite.config.js`

**配置内容**：
```javascript
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:8888',  // ❌ 错误！
      changeOrigin: true
    }
  }
}
```

**发现问题**：
- 前端代理配置的目标端口是 `8888`
- 但实际网关服务运行在 `8080` 端口
- 端口8888有其他Docker容器占用，并非我们的网关服务

### 第五步：验证问题根因

**操作**：测试8888端口的服务

```bash
# 测试8888端口
curl -v http://localhost:8888/api/auth/login
# 输出：返回500错误或连接失败
```

**结论**：8888端口的服务不是我们的网关，导致前端请求发送到了错误的服务。

---

## 🎯 根本原因

### 原因分析

**配置不一致**：
- 前端开发环境的Vite配置文件中，API代理目标端口配置为 `8888`
- 实际部署的网关服务运行在 `8080` 端口
- 配置与实际环境不匹配，导致前端请求无法到达正确的后端服务

### 为什么会出现这个问题？

可能的原因：
1. **环境变更**：之前开发时网关服务可能部署在8888端口，后来迁移到了8080端口
2. **配置未同步**：服务端口变更后，前端配置文件没有及时更新
3. **文档缺失**：没有明确的前后端端口对应关系文档

---

## ✅ 解决方案

### 修复步骤

**第一步：修改前端配置文件**

**文件**：`frontend/vite.config.js`

**修改前**：
```javascript
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:8888',  // ❌ 错误端口
      changeOrigin: true
    }
  }
}
```

**修改后**：
```javascript
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:8080',  // ✅ 正确端口
      changeOrigin: true
    }
  }
}
```

**第二步：重启前端开发服务器**

```bash
# 停止前端服务（按 Ctrl+C）

# 重新启动前端服务
cd frontend
npm run dev
```

**第三步：验证修复**

```bash
# 通过前端测试登录功能
# 浏览器访问 http://localhost:5173
# 输入用户名和密码，点击登录
# ✅ 登录成功，系统正常响应
```

---

## 📊 问题影响评估

| 评估项 | 说明 |
|--------|------|
| **影响用户** | 所有前端开发人员和测试人员 |
| **影响功能** | 登录、认证、需要Token的所有API |
| **影响时长** | 约10分钟 |
| **数据丢失** | 无 |
| **业务损失** | 低 - 仅影响开发环境 |

---

## 🔒 预防措施

### 1. 配置文件统一管理

**措施**：
- 将端口配置提取到环境变量中
- 在 `frontend/.env` 文件中定义后端服务地址

**示例**：
```bash
# frontend/.env.development
VITE_API_BASE_URL=http://localhost:8080
VITE_API_BASE_URL_TEST=http://localhost:8080
```

```javascript
// frontend/vite.config.js
export default defineConfig({
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: process.env.VITE_API_BASE_URL,
        changeOrigin: true
      }
    }
  }
})
```

### 2. 端口文档化

**措施**：在项目文档中明确记录各服务的端口配置

**文档位置**：`docs/端口配置说明.md`

**内容示例**：
```markdown
## 端口配置表

| 服务 | 开发环境端口 | 测试环境端口 | 生产环境端口 |
|------|------------|------------|------------|
| 前端开发服务器 | 5173 | - | - |
| 网关服务 | 8080 | 8080 | 8080 |
| 认证服务 | 8081 | 8081 | 8081 |
| 数据服务 | 8082 | 8082 | 8082 |
```

### 3. 健康检查脚本

**措施**：提供脚本快速检查各服务状态

**示例**：`scripts/check-services.sh`

```bash
#!/bin/bash

echo "检查服务状态..."

# 检查网关
if curl -s http://localhost:8080/actuator/health > /dev/null; then
  echo "✅ 网关服务 (8080) - 正常"
else
  echo "❌ 网关服务 (8080) - 异常"
fi

# 检查认证服务
if curl -s http://localhost:8081/actuator/health > /dev/null; then
  echo "✅ 认证服务 (8081) - 正常"
else
  echo "❌ 认证服务 (8081) - 异常"
fi
```

### 4. 启动顺序文档

**措施**：在快速开始文档中明确服务启动顺序和配置要求

**文档位置**：`docs/快速开始.md`

**内容更新**：
```markdown
## 启动服务

1. 启动网关服务（端口8080）
2. 启动认证服务（端口8081）
3. 启动数据服务（端口8082）
4. 确认前端配置中的代理端口为8080
5. 启动前端开发服务器
```

### 5. CI/CD配置检查

**措施**：在部署流程中添加配置验证

**示例**：
```yaml
# .github/workflows/deploy.yml
- name: 验证前端配置
  run: |
    # 检查配置文件中的端口是否与环境匹配
    if grep -q "localhost:8888" vite.config.js; then
      echo "❌ 前端配置端口错误！"
      exit 1
    fi
```

---

## 📝 经验总结

### 教训

1. **环境变更需要同步更新配置**：当后端服务端口变更时，必须及时更新所有相关的配置文件
2. **配置集中管理的重要性**：将配置集中到环境变量中，减少硬编码，便于维护
3. **文档化是关键**：明确记录各服务的端口和依赖关系，避免配置不一致
4. **启动前检查**：在启动前端开发服务器前，检查后端服务是否正常运行

### 最佳实践

1. ✅ **使用环境变量管理配置**：避免在代码中硬编码端口号
2. ✅ **配置文件版本控制**：所有配置文件纳入版本管理
3. ✅ **文档化端口映射**：在项目文档中明确记录端口配置
4. ✅ **提供健康检查脚本**：方便快速诊断服务状态
5. ✅ **建立配置变更流程**：任何配置变更都需要通知相关开发人员

---

## 📎 相关资源

| 资源 | 链接 |
|------|------|
| 前端配置文件 | `frontend/vite.config.js` |
| 环境变量配置 | `frontend/.env.development` |
| 端口配置文档 | `docs/端口配置说明.md` |
| 快速开始指南 | `docs/快速开始.md` |
| 故障排查指南 | `docs/故障排查指南.md` |

---

## 📞 联系信息

如有类似问题，请参考：

- **故障排查指南**：`docs/故障排查指南.md`
- **项目文档**：`docs/README.md`
- **技术支持**：开发团队

---

**文档创建**：2026-02-08  
**最后更新**：2026-02-08  
**维护人员**：开发团队
